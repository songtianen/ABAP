FUNCTION ZFM_OA_DFKSQ.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     REFERENCE(DFKNO) TYPE  ZTFI_PAYEEDOC-DFKNO OPTIONAL
*"     REFERENCE(CHGNO_D) TYPE  ZEFI_CHGNO_D OPTIONAL
*"     REFERENCE(ZDJBH) TYPE  ZE_ZDJBH OPTIONAL
*"     REFERENCE(P_TYPE) TYPE  CHAR10
*"     VALUE(WA_HEAD) TYPE  ZSFI205 OPTIONAL
*"     VALUE(FILEPATH) OPTIONAL
*"  EXPORTING
*"     REFERENCE(FLAG) TYPE  ZEMM_FLAG
*"     REFERENCE(MESSAGE) TYPE  ZEMM_MESSAGE
*"     REFERENCE(P_RESULT) TYPE  STRING
*"     REFERENCE(P_STATUS) TYPE  I
*"     REFERENCE(P_OUTPUT) TYPE  STRING
*"  TABLES
*"      T_FILE STRUCTURE  ZSFI208 OPTIONAL
*"----------------------------------------------------------------------
  DATA:DJLX  TYPE ZTFILE_MANAGE_01-DJLX,
       SAPNO TYPE ZTFILE_MANAGE_01-SAPNO.
  DATA:P_NAME    TYPE STRING,
       FULLPATH  TYPE STRING,
       FILE      TYPE STRING,
       EXTENSION TYPE STRING,
       O_FILE    TYPE STRING,
       FILESTR   TYPE STRING,
       FILESTR1  TYPE STRING,
       FILESTR3  TYPE STRING,
       FTPPATH   TYPE CHAR220,
       STATE     TYPE STRING,
       ID        TYPE STRING,
       MSG       TYPE BAPI_MSG,
       TYPE      TYPE BAPI_MTYPE,
       IN_STOCK  TYPE TABLE OF ZSFI202 WITH HEADER LINE.
  CLEAR:P_NAME,IN_STOCK[],FLAG,MESSAGE,ZTFI_PAYEEDOC.
  SELECT SINGLE *
    FROM ZTFI_PAYEEDOC
    WHERE CHGNO_D = CHGNO_D.
  CASE P_TYPE.
    WHEN 'DFK'.
      CLEAR ZTFI_SPLITCONT.
      P_NAME = ZTFI_PAYEEDOC-ZSQR.
      CLEAR IN_STOCK.
      IN_STOCK-BUKRS = ZTFI_PAYEEDOC-BUKRS.
      SELECT SINGLE BUTXT
        INTO IN_STOCK-BUTXT
        FROM T001
        WHERE BUKRS = ZTFI_PAYEEDOC-BUKRS.
      IN_STOCK-CHGNO_D = ZTFI_PAYEEDOC-CHGNO_D.
      IN_STOCK-DOCUNUM = ZTFI_PAYEEDOC-DFKNO.
      IN_STOCK-PARTNER = ZTFI_PAYEEDOC-PARTNER.
      IN_STOCK-ZREASON = ZTFI_PAYEEDOC-ZREASON.
      SELECT SINGLE NAME1
        INTO IN_STOCK-NAME_ORG1
        FROM KNA1
        WHERE KUNNR = ZTFI_PAYEEDOC-PARTNER.
      IN_STOCK-PAYEENAME = ZTFI_PAYEEDOC-PAYEENAME.
*      SELECT SINGLE NAME1
*        INTO IN_STOCK-PAYEENAME
*        FROM KNA1
*        WHERE KUNNR = ZTFI_PAYEEDOC-KUNWE.
      IN_STOCK-ZLKZH = ZTFI_PAYEEDOC-PAYEEACCTNO.
      IN_STOCK-ZLKJE = ZTFI_PAYEEDOC-DMBTR.
      IN_STOCK-Z_ZDR = ZTFI_PAYEEDOC-PZUSR.
      IN_STOCK-ZCATE = ZTFI_PAYEEDOC-ZCATE.
      IN_STOCK-ZSQR = ZTFI_PAYEEDOC-ZSQR.
        "ADD 20221223 BY HANWQ
       IN_STOCK-SEGMENT = ZTFI_PAYEEDOC-SEGMENT.
        SELECT SINGLE
          NAME
          INTO IN_STOCK-NAME
          FROM FAGL_SEGMT
          WHERE SEGMENT = ZTFI_PAYEEDOC-SEGMENT
           AND  LANGU  = SY-LANGU
            .
*      IN_STOCK-ZAPPEND = FULLPATH.
      IF ZDJBH IS NOT INITIAL."待垫款
        SELECT SINGLE *
          FROM ZTFI_SPLITCONT
          WHERE ZDJBH = ZDJBH.
        P_NAME = ZTFI_SPLITCONT-ZSQR.
        IN_STOCK-DOCUNUM = ZDJBH.
        IN_STOCK-PARTNER = ZTFI_SPLITCONT-PARTNER.
        IN_STOCK-ZREASON = ZTFI_SPLITCONT-ZREASON.
        IN_STOCK-ZCATE = ZTFI_SPLITCONT-ZCATE.
        SELECT SINGLE NAME1
          INTO IN_STOCK-NAME_ORG1
          FROM KNA1
          WHERE KUNNR = ZTFI_SPLITCONT-PARTNER.
      ENDIF.
      SELECT SINGLE DDTEXT
        INTO IN_STOCK-ZCATENA
        FROM DD07V
        WHERE DOMNAME = 'ZD_ZCATE'
        AND   DOMVALUE_L = IN_STOCK-ZCATE
        AND   DDLANGUAGE = SY-LANGU.
      APPEND IN_STOCK.
    WHEN 'ZQZY'.
      SELECT *
        INTO TABLE @DATA(IT_ZTFI_SPLITCONT)
        FROM ZTFI_SPLITCONT
        WHERE ZDJBH = @ZDJBH.
      CHECK SY-SUBRC = 0.
      READ TABLE IT_ZTFI_SPLITCONT INTO DATA(WA_SPLIT) INDEX 1.
      P_NAME = WA_SPLIT-ZSQR.
      CLEAR IN_STOCK.
      IN_STOCK-BUKRS = WA_SPLIT-BUKRS.
      SELECT SINGLE BUTXT
        INTO IN_STOCK-BUTXT
        FROM T001
        WHERE BUKRS = WA_SPLIT-BUKRS.
        "ADD 20221223 BY HANWQ
       IN_STOCK-SEGMENT = WA_SPLIT-SEGMENT.
        SELECT SINGLE
          NAME
          INTO IN_STOCK-NAME
          FROM FAGL_SEGMT
          WHERE SEGMENT = WA_SPLIT-SEGMENT
           AND  LANGU  = SY-LANGU
            .
      IN_STOCK-CHGNO_D = WA_SPLIT-CHGNO_D.
      IN_STOCK-DOCUNUM = ZDJBH.
      IN_STOCK-Z_ZDR = WA_HEAD-ZZDR.
      IN_STOCK-ZREASON = WA_HEAD-ZREASON.
      IN_STOCK-ZCATE = WA_HEAD-ZCATE.
      IN_STOCK-ZSQR = WA_HEAD-ZSQR.
      SELECT SINGLE DDTEXT
        INTO IN_STOCK-ZCATENA
        FROM DD07V
        WHERE DOMNAME = 'ZD_ZCATE'
        AND   DOMVALUE_L = WA_HEAD-ZCATE
        AND   DDLANGUAGE = SY-LANGU.
      IN_STOCK-PSPID_ZC = WA_HEAD-POSIDZC.
      IN_STOCK-PSPID_ZR = WA_HEAD-POSIDZR.
      IN_STOCK-POST1_ZC = WA_HEAD-POST1ZC.
      IN_STOCK-POST1_ZR = WA_HEAD-POST1ZR.
      IN_STOCK-ZUONR_ZC = WA_HEAD-VBELNZC.
      IN_STOCK-ZUONR_ZR = WA_HEAD-VBELNZR.
      IN_STOCK-PARTNER_ZC = WA_HEAD-KUNNRZC.
      IN_STOCK-PARTNER_ZR = WA_HEAD-KUNNRZR.
      SELECT SINGLE NAME1
        INTO IN_STOCK-NAME_ZC
        FROM KNA1
        WHERE KUNNR = WA_HEAD-KUNNRZC.
      SELECT SINGLE NAME1
        INTO IN_STOCK-NAME_ZR
        FROM KNA1
        WHERE KUNNR = WA_HEAD-KUNNRZR.
      IN_STOCK-VKBUR_ZR = WA_HEAD-YWBMZRT.
      IN_STOCK-VKBUR_ZC = WA_HEAD-YWBMZCT.
      IN_STOCK-ZDMBTR = WA_HEAD-DMBTR.
      IN_STOCK-ZAVCONT = WA_HEAD-XMYE.
*      IN_STOCK-ZAPPEND = FULLPATH.
      IN_STOCK-VKGRP_ZC = WA_HEAD-YWYZCT.
      IN_STOCK-VKGRP_ZR = WA_HEAD-YWYZRT.
      APPEND IN_STOCK.
  ENDCASE.
  SAPNO = IN_STOCK-DOCUNUM.
  DJLX = P_TYPE.
  DELETE T_FILE WHERE FILE IS INITIAL.
  LOOP AT T_FILE.
    CLEAR:ID,STATE,T_FILE-ID.
*根据路径获取文件名
    PERFORM GETFILEEXT(ZPUBFORM) USING T_FILE-FILE CHANGING T_FILE-FILENAME
       EXTENSION.
*上传附件到FTP
    CALL FUNCTION 'ZFM_FTP_UPFILE'
      EXPORTING
        FILEPATH = T_FILE-FILE
        SAPMK    = 'FICO'
        DJLX     = DJLX
        SAPNO    = SAPNO
      IMPORTING
        FULLPATH = FULLPATH
        FILE     = T_FILE-FILENAME_N
        O_FILE   = O_FILE
        RTYPE    = TYPE
        RTMSG    = MSG.
*成功后传输OA
    IF TYPE = 'S'.
      SPLIT O_FILE AT '.' INTO T_FILE-FILENAME_O EXTENSION.
      T_FILE-FTPPATH = FULLPATH.
      CALL FUNCTION 'ZFM_OA_UPFILE'
        EXPORTING
          P_NAME = P_NAME
          I_FILE = T_FILE
        IMPORTING
          STATE  = STATE
          ID     = ID.
      IF STATE = '200'.
        T_FILE-ID = ID.
      ENDIF.
      MODIFY T_FILE.
    ENDIF.
  ENDLOOP.
  LOOP AT T_FILE WHERE ID IS INITIAL.
    EXIT.
  ENDLOOP.
  IF SY-SUBRC EQ 0.
    FLAG = 'N'.
    MESSAGE = '附件传输失败'.
    RETURN.
  ENDIF.

  LOOP AT IN_STOCK.
    CLEAR:IN_STOCK-ZAPPEND.
    LOOP AT T_FILE WHERE ID IS NOT INITIAL .
      IF IN_STOCK-ZAPPEND IS INITIAL.
        IN_STOCK-ZAPPEND = T_FILE-ID.
      ELSE.
        CONCATENATE IN_STOCK-ZAPPEND T_FILE-ID
INTO IN_STOCK-ZAPPEND SEPARATED BY ','.
      ENDIF.
      MODIFY IN_STOCK TRANSPORTING ZAPPEND.
    ENDLOOP.
  ENDLOOP.

  CALL FUNCTION 'ZFM_GP_FI_OA_ZQZYSQ'
    EXPORTING
      P_NAME   = P_NAME
    IMPORTING
      FLAG     = FLAG
      MESSAGE  = MESSAGE
      P_RESULT = P_RESULT
      P_STATUS = P_STATUS
      P_OUTPUT = P_OUTPUT
    TABLES
      IN_STOCK = IN_STOCK.



ENDFUNCTION.
