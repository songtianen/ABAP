FUNCTION ZFM_OA_UPFILE.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(P_NAME) TYPE  STRING OPTIONAL
*"     VALUE(I_FILE) TYPE  ZSFI208 OPTIONAL
*"  EXPORTING
*"     VALUE(RTMSG) TYPE  BAPI_MSG
*"     VALUE(STATUS) TYPE  I
*"     VALUE(STATE) TYPE  STRING
*"     VALUE(ID) TYPE  STRING
*"     VALUE(O_STR) TYPE  STRING
*"     VALUE(I_STR) TYPE  STRING
*"     VALUE(O_URL) TYPE  STRING
*"----------------------------------------------------------------------
  ZFMDATASAVE1 'ZFM_OA_UPFILE'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.
  TYPES:BEGIN OF TY_LIST,
          FILE_PATH      TYPE STRING,
          FILE_CODE_NAME TYPE STRING,
          FILE_NEW_NAME  TYPE STRING,
        END OF TY_LIST.
  DATA:BEGIN OF INPUT,
         TOKEN TYPE STRING,
         LIST  TYPE TABLE OF TY_LIST,
       END OF INPUT,
       BEGIN OF OUTPUT,
         STATE TYPE STRING,
         LIST  TYPE TABLE OF STRING,
       END OF OUTPUT,
       IT_LIST TYPE TABLE OF TY_LIST WITH HEADER LINE.
  DATA:URL    TYPE STRING,
       INSTR  TYPE STRING,
       LIST   TYPE STRING,
       OUTMSG TYPE STRING,
       OUTSTR TYPE STRING.
  CHECK I_FILE IS NOT INITIAL.
*首先根据申请人获取TOKEN
*OAFILE
*获取附件传递的地址
  PERFORM GETDATA(ZPUB_DATA) USING 'OAFILE' CHANGING URL.
  CHECK URL IS NOT INITIAL.
  O_URL = URL.
*获取TOKEN
  CALL FUNCTION 'ZFM_GETOATOKEN'
    EXPORTING
      BS     = 'FILE'
      P_NAME = P_NAME
    IMPORTING
      OUTPUT = INPUT-TOKEN.
  CHECK INPUT-TOKEN IS NOT INITIAL.
  PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING URL.
*调用ECP接口
  CLEAR:IT_LIST[],IT_LIST,INPUT-LIST[],
  INSTR,OUTSTR.
  IT_LIST-FILE_PATH      = I_FILE-FTPPATH.
  IT_LIST-FILE_CODE_NAME = I_FILE-FILENAME_O.
  IT_LIST-FILE_NEW_NAME  = I_FILE-FILENAME_N.
  APPEND IT_LIST.
  INPUT-LIST = IT_LIST[].
*转JSON
  CALL FUNCTION 'ZFMS_14_JSON'
    EXPORTING
      PRETTY_NAME = 'X'
    CHANGING
      JSONSTR     = INSTR
      DATA        = INPUT
    EXCEPTIONS
      OTHERS      = 1.
  I_STR = INSTR.
  CALL FUNCTION 'ZFMS_15_HTTP'
    EXPORTING
      INPUT     = INSTR
      URL       = URL
      REQMETHOD = 'POST' "HTTP 方法
      HTTP1_1   = '' "协议1.1/1.0
    IMPORTING
      OUTPUT    = OUTSTR "返回JSON报文
      RTMSG     = OUTMSG "消息
      STATUS    = STATUS "HTTP状态
    EXCEPTIONS
      OTHERS    = 1.
  O_STR = OUTSTR.
  CALL FUNCTION 'ZFMS_14_JSON'
    CHANGING
      JSONSTR = OUTSTR
      DATA    = OUTPUT
    EXCEPTIONS
      OTHERS  = 1.
  STATE = OUTPUT-STATE.
  READ TABLE OUTPUT-LIST INTO LIST INDEX 1.
  ID = LIST.
  IF ID IS INITIAL.
    RTMSG = '未获取到附件ID'.
  ENDIF.
  ZFMDATASAVE2 'R'.
ENDFUNCTION.
