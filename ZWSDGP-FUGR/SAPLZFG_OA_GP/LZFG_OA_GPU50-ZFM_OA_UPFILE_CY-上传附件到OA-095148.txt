FUNCTION ZFM_OA_UPFILE_CY.
*"--------------------------------------------------------------------
*"*"局部接口：
*"  IMPORTING
*"     VALUE(P_NAME) TYPE  STRING
*"     VALUE(FILENAME) TYPE  STRING
*"     VALUE(FILEPATH) TYPE  STRING
*"  EXPORTING
*"     REFERENCE(RTMSG) TYPE  BAPI_MSG
*"     REFERENCE(STATUS) TYPE  I
*"     REFERENCE(OUTPUT) TYPE  STRING
*"     REFERENCE(O_ZSFI210) TYPE  ZSFI210
*"     REFERENCE(FILEURL) TYPE  STRING
*"--------------------------------------------------------------------
*  ZFMDATASAVE1 'ZFM_OA_UPFILE'.
*  ZFMDATASAVE2 'B'.
*  COMMIT WORK.
  DATA:BEGIN OF WA OCCURS 0,
         N_A_S TYPE STRING,
         ATTS  TYPE TABLE OF ZSFI210,
       END OF WA,
       WA_TAB1 TYPE ZSFI210.


  DATA:TOKEN       TYPE STRING,
       HTTP_OBJECT TYPE REF TO IF_HTTP_CLIENT,
       LO_PART     TYPE REF TO IF_HTTP_ENTITY,
       LENGTH      TYPE I,
       BUFFER      TYPE XSTRING,
       FILEURL1    TYPE STRING,
       RESULT      TYPE STRING,
       STR         TYPE STRING,
       MESSAGE     TYPE STRING,
       FIELDS      TYPE TIHTTPNVP.
  DATA:DATA_TAB  TYPE TABLE OF BAPICONTEN WITH HEADER LINE.
  CLEAR:FILEURL,O_ZSFI210.
*将上传文件转为二进制
  CALL FUNCTION 'GUI_UPLOAD'
    EXPORTING
      FILENAME                = FILEPATH
      FILETYPE                = 'BIN'
      CODEPAGE                = '4110'
    IMPORTING
      FILELENGTH              = LENGTH
    TABLES
      DATA_TAB                = DATA_TAB
    EXCEPTIONS
      FILE_OPEN_ERROR         = 1
      FILE_READ_ERROR         = 2
      NO_BATCH                = 3
      GUI_REFUSE_FILETRANSFER = 4
      INVALID_TYPE            = 5
      NO_AUTHORITY            = 6
      UNKNOWN_ERROR           = 7
      BAD_DATA_FORMAT         = 8
      HEADER_NOT_ALLOWED      = 9
      SEPARATOR_NOT_ALLOWED   = 10
      HEADER_TOO_LONG         = 11
      UNKNOWN_DP_ERROR        = 12
      ACCESS_DENIED           = 13
      DP_OUT_OF_MEMORY        = 14
      DISK_FULL               = 15
      DP_TIMEOUT              = 16
      OTHERS                  = 17.
  CHECK SY-SUBRC = 0.
*首先根据申请人获取TOKEN
*OAFILE
*获取附件传递的地址
  PERFORM GETDATA(ZPUB_DATA) USING 'OAFILE' CHANGING FILEURL1.
  CHECK FILEURL1 IS NOT INITIAL.
*获取TOKEN
  CALL FUNCTION 'ZFM_GETOATOKEN'
    EXPORTING
      BS     = 'FILE'
      P_NAME = P_NAME
    IMPORTING
      OUTPUT = TOKEN.
  CHECK TOKEN IS NOT INITIAL.
*  CONCATENATE FILEURL1 TOKEN INTO FILEURL1.
  FILEURL1 = 'http://192.168.0.134:8085/seeyon/rest/attachment'.
*获取系统当前的CODE
*调用HTTP地址
* 创建URL对象
  CALL METHOD CL_HTTP_CLIENT=>CREATE_BY_URL "/CREATE(直接通过IP端口)
    EXPORTING
      URL                = FILEURL1
    IMPORTING
      CLIENT             = HTTP_OBJECT
    EXCEPTIONS
      ARGUMENT_NOT_FOUND = 1
      PLUGIN_NOT_ACTIVE  = 2
      INTERNAL_ERROR     = 3
      OTHERS             = 4.
  IF SY-SUBRC NE 0.
    HTTP_OBJECT->GET_LAST_ERROR( IMPORTING MESSAGE = MESSAGE ).
    RTMSG = MESSAGE.
    RETURN.
  ENDIF.
  HTTP_OBJECT->REQUEST->SET_HEADER_FIELD( NAME = 'token' VALUE = TOKEN ).
*不显示登录屏幕
  HTTP_OBJECT->PROPERTYTYPE_LOGON_POPUP = HTTP_OBJECT->CO_DISABLED.
*设置POST
  HTTP_OBJECT->REQUEST->SET_METHOD( IF_HTTP_REQUEST=>CO_REQUEST_METHOD_POST ).
*设置类型
  CALL METHOD HTTP_OBJECT->REQUEST->SET_CONTENT_TYPE
    EXPORTING
      CONTENT_TYPE = 'multipart/form-data'.
  HTTP_OBJECT->REQUEST->SET_HEADER_FIELD( NAME = 'Accept' VALUE = 'application/json' ).


  LO_PART = HTTP_OBJECT->REQUEST->IF_HTTP_ENTITY~ADD_MULTIPART( ).
  LO_PART->SET_CONTENT_TYPE( CONTENT_TYPE ='application/octet-stream' ).
  LO_PART->SET_HEADER_FIELD( NAME  = IF_HTTP_HEADER_FIELDS=>CONTENT_DISPOSITION
                          VALUE = 'form-data;name="txt";filename="XXXXTEST.TXT"' ).

  CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
    EXPORTING
      INPUT_LENGTH = LENGTH
    IMPORTING
      BUFFER       = BUFFER
    TABLES
      BINARY_TAB   = DATA_TAB
    EXCEPTIONS
      FAILED       = 1
      OTHERS       = 2.

*传输
*  LENGTH = STRLEN( STR ).
  LENGTH = XSTRLEN( BUFFER ).
  CALL METHOD HTTP_OBJECT->REQUEST->SET_DATA "SET_CDATA
*  CALL METHOD LO_PART->SET_CDATA
    EXPORTING
      DATA   = BUFFER
      OFFSET = 0
      LENGTH = LENGTH.
*发送HTTP请求
  CALL METHOD HTTP_OBJECT->SEND
    EXCEPTIONS
      HTTP_COMMUNICATION_FAILURE = 1
      HTTP_INVALID_STATE         = 2
      OTHERS                     = 3.
  IF SY-SUBRC NE 0.
    HTTP_OBJECT->GET_LAST_ERROR( IMPORTING MESSAGE = MESSAGE ).
    RTMSG = MESSAGE.
    HTTP_OBJECT->CLOSE( ).
    RETURN.
  ENDIF.
*接收返回消息
  CALL METHOD HTTP_OBJECT->RECEIVE
    EXCEPTIONS
      HTTP_COMMUNICATION_FAILURE = 1
      HTTP_INVALID_STATE         = 2
      HTTP_PROCESSING_FAILED     = 3
      OTHERS                     = 4.
  IF SY-SUBRC NE 0.
    HTTP_OBJECT->GET_LAST_ERROR( IMPORTING MESSAGE = MESSAGE ).
    RTMSG = MESSAGE.
    HTTP_OBJECT->CLOSE( ).
    RETURN.
  ENDIF.
*获取结果
  CLEAR:LENGTH.
  CALL METHOD HTTP_OBJECT->RESPONSE->GET_STATUS
    IMPORTING
      CODE   = LENGTH
      REASON = MESSAGE.
  RTMSG = MESSAGE.
  STATUS = LENGTH.
*获取返回
  CALL METHOD HTTP_OBJECT->RESPONSE->GET_HEADER_FIELDS
    CHANGING
      FIELDS = FIELDS.
  RESULT = HTTP_OBJECT->RESPONSE->GET_CDATA( ).
  IF SY-SUBRC NE 0.
    HTTP_OBJECT->GET_LAST_ERROR( IMPORTING MESSAGE = MESSAGE ).
    RTMSG = MESSAGE.
    HTTP_OBJECT->CLOSE( ).
    RETURN.
  ENDIF.
  MESSAGE = HTTP_OBJECT->RESPONSE->GET_DATA( ).
  HTTP_OBJECT->CLOSE( ).
  OUTPUT = RESULT.
*解析出OAFILEURL
  CLEAR :FILEURL,O_ZSFI210.
  CALL FUNCTION 'ZFMS_14_JSON'
    CHANGING
      JSONSTR = OUTPUT
      DATA    = WA
    EXCEPTIONS
      OTHERS  = 1.
  READ TABLE WA-ATTS INTO O_ZSFI210 INDEX 1.
  FILEURL = O_ZSFI210-FILEURL.

*  ZFMDATASAVE2 'R'.
ENDFUNCTION.
