FUNCTION ZFM_GP_PS_OA_XMZTBG.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(PS_PSPID) TYPE  PS_PSPID
*"     VALUE(ZXMZT) TYPE  ZE_ZXMZT_OA OPTIONAL
*"  TABLES
*"      OT_TAB STRUCTURE  ZSMM_017
*"----------------------------------------------------------------------
  ZFMDATASAVE1 'ZFM_GP_PS_OA_XMZTBG'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.

  CONSTANTS: US_STATUS_1 TYPE BAPI_USER_STATUS_TEXT VALUE '签订'.
  CONSTANTS: US_STATUS_2 TYPE BAPI_USER_STATUS_TEXT VALUE '赢单'.
  CONSTANTS: US_STATUS_3 TYPE BAPI_USER_STATUS_TEXT VALUE '开工'.
  CONSTANTS: US_STATUS_4 TYPE BAPI_USER_STATUS_TEXT VALUE '提前启动'.
  CONSTANTS: US_STATUS_5 TYPE BAPI_USER_STATUS_TEXT VALUE '完工'.
  CONSTANTS: US_STATUS_6 TYPE BAPI_USER_STATUS_TEXT VALUE '结算'.
  CONSTANTS: US_STATUS_7 TYPE BAPI_USER_STATUS_TEXT VALUE '完结'.
  CONSTANTS: US_STATUS_8 TYPE BAPI_USER_STATUS_TEXT VALUE '内部验收'.
  CONSTANTS: US_STATUS_9 TYPE BAPI_USER_STATUS_TEXT VALUE '外部验收'.

  DATA: ES_RETURN     TYPE BAPIRETURN1,
        US_STATUS     TYPE BAPI_USER_STATUS_TEXT,
        SYS_STATUS    TYPE BAPI_SYSTEM_STATUS_TEXT,
        SYSTEM_STATUS TYPE TABLE OF BAPI_SYSTEM_STATUS,
        USER_STATUS   TYPE TABLE OF BAPI_USER_STATUS,
        STATUS_RESULT TYPE TABLE OF BAPI_STATUS_RESULT,
        PJT_CHG       TYPE TABLE OF BAPI_BUS2001_CHG WITH HEADER LINE,
        PJT_UPD       TYPE TABLE OF BAPI_BUS2001_UPD WITH HEADER LINE,
        ET_RETURN     TYPE TABLE OF BAPIRET2 WITH HEADER LINE.

  CLEAR: ES_RETURN , OT_TAB , OT_TAB[] .
  CLEAR: US_STATUS , SYS_STATUS.
  CASE ZXMZT.
    WHEN 1.
      US_STATUS = US_STATUS_4 .
      SYS_STATUS = 'REL' .
    WHEN 2.
      US_STATUS = US_STATUS_3 .
      SYS_STATUS = 'REL' .
    WHEN 3.
      US_STATUS = US_STATUS_5 .
    WHEN 4.
      US_STATUS = US_STATUS_8 .
    WHEN 5.
      US_STATUS = US_STATUS_9 .
    WHEN 6.
      US_STATUS = US_STATUS_6 .
    WHEN 7.
      US_STATUS = US_STATUS_3 .
    WHEN 8.
      US_STATUS = US_STATUS_7 .
  ENDCASE.
*PS_PSPID = 'Y1N22006'.
*SYSTEM_STATUS = 'E0004' .
*SYS_STATUS = 'REL' .
*US_STATUS = '开工' .

*CALL FUNCTION 'BAPI_PS_INITIALIZATION'.
*CALL FUNCTION 'BAPI_BUS2001_GET_STATUS'
*  EXPORTING
*    PROJECT_DEFINITION = PS_PSPID
*  IMPORTING
*    RETURN             = ES_RETURN
*  TABLES
*    E_SYSTEM_STATUS    = SYSTEM_STATUS
*    E_USER_STATUS      = USER_STATUS
*  .  "  BAPI_BUS2001_GET_STATUS
*
*BREAK-POINT .

  CALL FUNCTION 'BAPI_PS_INITIALIZATION'.

  CALL FUNCTION 'BAPI_BUS2001_SET_STATUS'
    EXPORTING
      PROJECT_DEFINITION = PS_PSPID
*     UNDO_SYSTEM_STATUS =
*     UNDO_USER_STATUS   =
      SET_SYSTEM_STATUS  = SYS_STATUS
      SET_USER_STATUS    = US_STATUS
    IMPORTING
      RETURN             = ES_RETURN
    TABLES
      E_RESULT           = STATUS_RESULT.


  IF ES_RETURN-TYPE CA 'AEX'.
    OT_TAB-MESSAGE = ES_RETURN-MESSAGE.
  ENDIF.

  IF OT_TAB-MESSAGE IS INITIAL.
    CALL FUNCTION 'BAPI_PS_PRECOMMIT'.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        WAIT = 'X'.
    OT_TAB-FLAG = 'Y'.
    OT_TAB-MESSAGE = '状态更新成功'.
    APPEND OT_TAB.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
    OT_TAB-FLAG = 'N'.
    OT_TAB-MESSAGE = '用户状态更新失败' && OT_TAB-MESSAGE.
    APPEND OT_TAB.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.


  ZFMDATASAVE2 'R'.


ENDFUNCTION.
