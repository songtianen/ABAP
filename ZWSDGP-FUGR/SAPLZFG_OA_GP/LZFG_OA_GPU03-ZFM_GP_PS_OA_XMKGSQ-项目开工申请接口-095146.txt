FUNCTION ZFM_GP_PS_OA_XMKGSQ.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(PS_PSPID) TYPE  PS_PSPID
*"     VALUE(USRDATE) TYPE  USRDATE DEFAULT SY-DATUM
*"  TABLES
*"      OT_TAB STRUCTURE  ZSMM_017
*"----------------------------------------------------------------------
  ZFMDATASAVE1 'ZFM_GP_PS_OA_XMKGSQ'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.

  CONSTANTS: US_STATUS TYPE BAPI_USER_STATUS_TEXT VALUE '开工'.
*  CONSTANTS: SY_STATUS TYPE BAPI_USER_STATUS_TEXT VALUE 'REL'.

  DATA: ES_RETURN     TYPE BAPIRETURN1,
        SYS_STATUS    TYPE BAPI_SYSTEM_STATUS_TEXT,
        SYSTEM_STATUS TYPE TABLE OF BAPI_SYSTEM_STATUS,
        USER_STATUS   TYPE TABLE OF BAPI_USER_STATUS,
        STATUS_RESULT TYPE TABLE OF BAPI_STATUS_RESULT,
        PJT_CHG       TYPE TABLE OF BAPI_BUS2001_CHG WITH HEADER LINE,
        PJT_UPD       TYPE TABLE OF BAPI_BUS2001_UPD WITH HEADER LINE,
        ET_RETURN     TYPE TABLE OF BAPIRET2 WITH HEADER LINE.

  CLEAR: ES_RETURN , OT_TAB , OT_TAB[] .

*PS_PSPID = 'Y1N22006'.
*SYSTEM_STATUS = 'E0004' .
*SYS_STATUS = 'REL' .
*US_STATUS = '开工' .

*CALL FUNCTION 'BAPI_PS_INITIALIZATION'.
*CALL FUNCTION 'BAPI_BUS2001_GET_STATUS'
*  EXPORTING
*    PROJECT_DEFINITION = PS_PSPID
*  IMPORTING
*    RETURN             = ES_RETURN
*  TABLES
*    E_SYSTEM_STATUS    = SYSTEM_STATUS
*    E_USER_STATUS      = USER_STATUS
*  .  "  BAPI_BUS2001_GET_STATUS
*
*BREAK-POINT .

  CALL FUNCTION 'BAPI_PS_INITIALIZATION'.

  CALL FUNCTION 'BAPI_BUS2001_SET_STATUS'
    EXPORTING
      PROJECT_DEFINITION = PS_PSPID
*     UNDO_SYSTEM_STATUS =
*     UNDO_USER_STATUS   =
*     SET_SYSTEM_STATUS  =
      SET_USER_STATUS    = US_STATUS
    IMPORTING
      RETURN             = ES_RETURN
    TABLES
      E_RESULT           = STATUS_RESULT.


  IF ES_RETURN-TYPE CA 'AEX'.
    OT_TAB-MESSAGE = ES_RETURN-MESSAGE.
  ENDIF.

  IF OT_TAB-MESSAGE IS INITIAL.
    CALL FUNCTION 'BAPI_PS_PRECOMMIT'.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        WAIT = 'X'.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
    OT_TAB-FLAG = 'N'.
    OT_TAB-MESSAGE = '用户状态更新失败'.
    APPEND OT_TAB.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.

  CLEAR: ET_RETURN , ET_RETURN[] , PJT_UPD ,PJT_UPD[] , PJT_UPD , PJT_UPD[] .
  PJT_CHG-PROJECT_DEFINITION = PS_PSPID.
  PJT_CHG-USR08 = USRDATE.
  APPEND PJT_CHG .
  PJT_UPD-USER_FIELD_DATE1 = 'X'.
  APPEND PJT_UPD .

  CALL FUNCTION 'BAPI_PS_INITIALIZATION'.

  CALL FUNCTION 'BAPI_BUS2001_CHANGE'
    EXPORTING
      I_PROJECT_DEFINITION     = PJT_CHG
      I_PROJECT_DEFINITION_UPD = PJT_UPD
    TABLES
      ET_RETURN                = ET_RETURN
*     EXTENSIONIN              =
*     EXTENSIONOUT             =
    .

  IF ES_RETURN-TYPE CA 'AEX'.
    OT_TAB-MESSAGE = ES_RETURN-MESSAGE.
  ENDIF.

  IF OT_TAB-MESSAGE IS INITIAL.
    CALL FUNCTION 'BAPI_PS_PRECOMMIT'.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        WAIT = 'X'.
    OT_TAB-FLAG = 'Y'.
    OT_TAB-MESSAGE = '状态更新成功'.
    APPEND OT_TAB.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
    OT_TAB-FLAG = 'N'.
    OT_TAB-MESSAGE = '更新开工日期失败'.
    APPEND OT_TAB.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.

  ZFMDATASAVE2 'R'.


ENDFUNCTION.
