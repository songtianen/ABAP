FUNCTION ZFM_GP_FICO_OA_XMXXCX.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(BUKRS) TYPE  BUKRS
*"  TABLES
*"      OTTAB STRUCTURE  ZSFI206
*"----------------------------------------------------------------------
  ZFMDATASAVE1 'ZFM_GP_FICO_OA_XMXXCX'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.
  DATA: IT_FAGL  LIKE TABLE OF FAGL_SEGMT WITH HEADER LINE,
        IT_TVGRT LIKE TABLE OF TVGRT WITH HEADER LINE.
*  DATA:BEGIN OF it_ljykp OCCURS 0,"累计已开票金额
*         pspid     LIKE ztfi_001b-pspid,
*         dmbtrtaxa LIKE ztfi_001b-dmbtrtaxa,
*       END OF it_ljykp.
  DATA:BEGIN OF IT_LJFY OCCURS 0,"累计已发生费用
         PSPID  LIKE COEP-PSPID,
         WTGBTR LIKE COEP-WTGBTR,
       END OF IT_LJFY.
  DATA:BEGIN OF IT_LJSK OCCURS 0,"累计收款金额
         PSPID LIKE ZTFI_SPLITCONT-PSPID,
         DMBTR LIKE ZTFI_SPLITCONT-DMBTR,
       END OF IT_LJSK.
  DATA:BEGIN OF IT_JKCS OCCURS 0,"借款次数
         PSPID LIKE ZTFI_PYREHD-PSPID,
         ZSQCS TYPE INT4,
       END OF IT_JKCS.
  CLEAR : OTTAB , OTTAB[] .

  SELECT
    PRPS~POSID AS PSPID
    PRPS~POST1 AS PSNAME
    PRPS~PBUKR AS BUKRS
    T001~BUTXT
    PRPS~PSPHI AS PSID_DEFIN
    PRPS~POST1 AS PSNAME_DEFIN
*    ZTPS010A~KUNNR
*    ZTPS010A~NAME1
    PRPS~PRCTR AS SEGMENT "利润中心
*    ZTPS010A~ZZYWY AS STAFFN_SALE "业务员
*    ZTPS010A~VERNR"负责人编号
*    ZTPS010A~VERNA"负责人姓名
*    ZTPS010A~ZGSBM"部门编号
    INTO CORRESPONDING FIELDS OF TABLE OTTAB
    FROM PRPS
*    LEFT JOIN ZTPS010A ON ZTPS010A~PSPID = PRPS~POSID
    INNER JOIN T001 ON PRPS~PBUKR = T001~BUKRS AND T001~SPRAS = '1'
    WHERE
    PRPS~PBUKR = BUKRS
    AND PRPS~BELKZ = 'X'
    AND PRPS~FAKKZ = 'X'.
  "业务员部门编码
  LOOP AT OTTAB.
    CALL FUNCTION 'CONVERSION_EXIT_KONPD_OUTPUT'
      EXPORTING
        INPUT  = OTTAB-PSID_DEFIN
      IMPORTING
        OUTPUT = OTTAB-PSID_DEFIN.
    MODIFY OTTAB.
  ENDLOOP.
  SELECT
  KUNNR,
  NAME1,
  ZZYWY AS STAFFN_SALE, "业务员
  VERNR,"负责人编号
  VERNA,"负责人姓名
  ZGSBM,"部门编号
  PSPID
  INTO TABLE @DATA(IT_A)
  FROM ZTPS010A
  FOR ALL ENTRIES IN @OTTAB
  WHERE PSPID = @OTTAB-PSID_DEFIN.
  LOOP AT OTTAB.
    READ TABLE IT_A INTO DATA(WA) WITH KEY  PSPID = OTTAB-PSID_DEFIN.
    IF SY-SUBRC = 0.
      OTTAB-KUNNR = WA-KUNNR.
      OTTAB-NAME1 = WA-NAME1.
      OTTAB-STAFFN_SALE = WA-STAFFN_SALE.
      OTTAB-VERNR = WA-VERNR.
      OTTAB-VERNA = WA-VERNA.
      OTTAB-ZGSBM = WA-ZGSBM.
      OTTAB-PSPID = WA-PSPID.
    ENDIF.
    MODIFY OTTAB.
  ENDLOOP.
  "取产业公司描述
  SELECT
    *
    INTO CORRESPONDING FIELDS OF TABLE IT_FAGL
    FROM FAGL_SEGMT
    WHERE LANGU = '1'.
  " 取部门描述
  SELECT
    *
   INTO CORRESPONDING FIELDS OF TABLE IT_TVGRT
    FROM TVGRT
    WHERE SPRAS = '1'.
  " 取累计已开票金额
*  SELECT
*     PSPID
*     DMBTRTAXA
*    INTO CORRESPONDING FIELDS OF TABLE IT_ZTFI_001B
*     FROM ZTFI_001B
*     FOR ALL ENTRIES IN OTTAB
*     WHERE ZTFI_001B~PSPID = OTTAB-PSPID .
  " 取累计已收款金额
  SELECT
    PSPID
    DMBTR
   INTO CORRESPONDING FIELDS OF TABLE IT_LJSK
    FROM ZTFI_SPLITCONT
    FOR ALL ENTRIES IN OTTAB
    WHERE ZTFI_SPLITCONT~PSPID = OTTAB-PSPID.

  " 取累计已发生费用
  SELECT
    PSPID
    WTGBTR
   INTO CORRESPONDING FIELDS OF TABLE IT_LJFY
    FROM COEP
    FOR ALL ENTRIES IN OTTAB
    WHERE COEP~PSPNR = OTTAB-PSPID AND COEP~WRTTP = '4'.

  " 取项目借款次数
  SELECT
    PSPID,
    COUNT( * ) AS ZSQCS
   INTO CORRESPONDING FIELDS OF TABLE @IT_JKCS
  FROM ZTFI_PYREHD
   WHERE ZTFI_PYREHD~ZRETYPE = '70' AND ZTFI_PYREHD~ZPRSTUS IN ('01','19','20','21','25') AND BUKRS = @BUKRS
    GROUP BY PSPID
    .
  COLLECT: IT_LJSK,IT_LJFY.
  LOOP AT OTTAB.
    READ TABLE IT_FAGL WITH KEY SEGMENT+6(4) = OTTAB-SEGMENT+2(4).
    IF SY-SUBRC = 0.
      OTTAB-ZSEG_NAME = IT_FAGL-NAME.
    ENDIF.
    READ TABLE IT_TVGRT WITH KEY VKGRP = OTTAB-ZGSBM.
    IF SY-SUBRC = 0.
      OTTAB-ZDEPT = IT_TVGRT-BEZEI.
    ENDIF.
    READ TABLE IT_LJSK WITH KEY PSPID = OTTAB-PSPID.
    IF SY-SUBRC = 0.
      OTTAB-DMBTR_SK = IT_LJSK-DMBTR.
    ENDIF.
    READ TABLE IT_LJFY WITH KEY PSPID = OTTAB-PSPID.
    IF SY-SUBRC = 0.
      OTTAB-DMBTR_FY = IT_LJFY-WTGBTR.
    ENDIF.
    READ TABLE IT_JKCS WITH KEY PSPID = OTTAB-PSPID.
    IF SY-SUBRC = 0.
      OTTAB-ZSQCS = IT_JKCS-ZSQCS.
    ENDIF.
    MODIFY OTTAB.
    CLEAR OTTAB.
  ENDLOOP.
  ZFMDATASAVE2 'R'.

ENDFUNCTION.
