FUNCTION ZFM_GP_FI_OA_ZQZYSQ.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(P_NAME) TYPE  STRING
*"  EXPORTING
*"     VALUE(FLAG) TYPE  ZEMM_FLAG
*"     VALUE(MESSAGE) TYPE  ZEMM_MESSAGE
*"     VALUE(P_RESULT) TYPE  STRING
*"     VALUE(P_STATUS) TYPE  I
*"     VALUE(P_OUTPUT) TYPE  STRING
*"  TABLES
*"      IN_STOCK STRUCTURE  ZSFI202
*"----------------------------------------------------------------------

  ZFMDATASAVE1 'ZFM_GP_FI_OA_ZQZYSQ'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.

  TYPES: BEGIN OF ZSZQZYSQTOCHAR,
           BUKRS      TYPE  CHAR4,
           BUTXT      TYPE  CHAR25,
           SEGMENT    TYPE  FB_SEGMENT,
           NAME       TYPE  TEXT50,
           DOCUNUM    TYPE  CHAR15,
           CHGNO_D    TYPE  CHAR12,
           PAYEENAME  TYPE  CHAR35,
           PARTNER    TYPE  CHAR17,
           NAME_ORG1  TYPE  CHAR40,
           ZLKZH      TYPE  CHAR32,
           ZLKJE      TYPE  CHAR20,
           Z_ZDR      TYPE  CHAR10,
           PSPID_ZC   TYPE  CHAR24,
           POST1_ZC   TYPE  CHAR40,
           ZUONR_ZC   TYPE  CHAR18,
           PARTNER_ZC TYPE  CHAR17,
           NAME_ZC    TYPE  CHAR35,
           VKGRP_ZC   TYPE  CHAR10,
           VKBUR_ZC   TYPE  CHAR20,
           ZDMBTR     TYPE  CHAR20,
           ZAVCONT    TYPE  CHAR20,
           PSPID_ZR   TYPE  CHAR24,
           POST1_ZR   TYPE  CHAR40,
           ZUONR_ZR   TYPE  CHAR18,
           PARTNER_ZR TYPE  CHAR10,
           NAME_ZR    TYPE  CHAR35,
           VKGRP_ZR   TYPE  CHAR10,
           VKBUR_ZR   TYPE  CHAR20,
           ZAPPEND    TYPE  CHAR200,
           ZREASON    TYPE  CHAR30,
           ZCATE      TYPE  CHAR10,
           ZCATENA    TYPE  CHAR50,
           ZSQR       TYPE  CHAR10,
         END OF ZSZQZYSQTOCHAR.

  DATA:BEGIN OF WA_INPUT1,
         INTAB TYPE TABLE OF ZSZQZYSQTOCHAR,
       END OF WA_INPUT1,
       BEGIN OF WA_INPUT,
         DATA LIKE WA_INPUT1,
       END OF WA_INPUT,
       BEGIN OF WA_OUTPUT1,
         FLAG    TYPE ZEMM_FLAG,
         MESSAGE TYPE ZEMM_MESSAGE,
       END OF WA_OUTPUT1,
       BEGIN OF WA_OUTPUT,
         DATA LIKE WA_OUTPUT1,
       END OF WA_OUTPUT.

  DATA : GT_ZQZYSQ TYPE TABLE OF ZSZQZYSQTOCHAR WITH HEADER LINE.

  IF  IN_STOCK[] IS INITIAL.
    FLAG = 'N'.
    MESSAGE = '未输入数据'.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.

  LOOP AT IN_STOCK.
    MOVE-CORRESPONDING IN_STOCK TO GT_ZQZYSQ.
    GT_ZQZYSQ-ZDMBTR      = IN_STOCK-ZDMBTR .
    CONDENSE GT_ZQZYSQ-ZDMBTR.
    GT_ZQZYSQ-ZLKJE       = IN_STOCK-ZLKJE .
    CONDENSE GT_ZQZYSQ-ZLKJE.
    CONDENSE GT_ZQZYSQ-ZAVCONT."去空格 ADD BY LZF 01.11.2022 09:34:29
    APPEND GT_ZQZYSQ.
  ENDLOOP.


  CLEAR:OASTR1,OASTR2,OAURL,WA_INPUT,WA_OUTPUT,
  OAHEAD[],OASTA,OAMSG.

*URL改为可配置，ZMM000
  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GP_FI_OA_ZQZYSQ' CHANGING OAURL.

*  CASE SY-SYSID.
*    WHEN 'DEV'.
*      OAURL = 'http://192.168.0.88:8080/seeyon/rest/dee/task/SD0075'.
*    WHEN 'QAS'.
*    WHEN 'PRD'.
*  ENDCASE.
*  CHECK OAURL IS NOT INITIAL.
  IF OAURL IS INITIAL.
    FLAG = 'N'.
    MESSAGE = 'OAURL获取失败'.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.
*根据传入数据转JSON
  WA_INPUT-DATA-INTAB = GT_ZQZYSQ[].
*SAP结构转JSON
  CALL FUNCTION 'ZFMS_14_JSON'
    CHANGING
      JSONSTR = OASTR1
      DATA    = WA_INPUT
    EXCEPTIONS
      OTHERS  = 1.

  SHIFT OASTR1 LEFT  DELETING LEADING  '{'.

  CONCATENATE '{"senderLoginName":"'
  P_NAME
  '",'
  OASTR1 INTO OASTR1.

  P_RESULT = OASTR1.

*获取TOKEN
  CALL FUNCTION 'ZFM_GETOATOKEN'
    IMPORTING
      OUTPUT = OASTR2
    EXCEPTIONS
      OTHERS = 1.

*  CHECK OASTR2 IS NOT INITIAL.
  IF OASTR2 IS INITIAL.
    FLAG = 'N'.
    MESSAGE = 'OATOKEN获取失败'.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.
*填入HEADER
  CLEAR:OAMSG,OASTA.
  REFRESH:OAHEAD.
  CLEAR OAHEAD.
  OAHEAD-NAME = 'token'.
  OAHEAD-VALUE = OASTR2.
  APPEND OAHEAD.
*调用函数HTTP
  CLEAR OASTR2.

  PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING OAURL.
  CALL FUNCTION 'ZFMS_15_HTTP'
    EXPORTING
      INPUT     = OASTR1
      URL       = OAURL
      REQMETHOD = 'POST' "HTTP 方法
      HTTP1_1   = 'X' "协议1.1/1.0
    IMPORTING
      OUTPUT    = OASTR2 "返回JSON报文
      RTMSG     = OAMSG "消息
      STATUS    = OASTA "HTTP状态
    TABLES
      HEADER    = OAHEAD
    EXCEPTIONS
      OTHERS    = 1.
*返回报文转为SAP结构
  CALL FUNCTION 'ZFMS_14_JSON'
    CHANGING
      JSONSTR = OASTR2
      DATA    = WA_OUTPUT
    EXCEPTIONS
      OTHERS  = 1.


  IF OASTA = '200'.
    FLAG =  'Y'.
    MESSAGE = '提交OA成功'.
  ELSE.
    FLAG = 'N'.
    MESSAGE = '提交OA失败'.
  ENDIF.


  ZFMDATASAVE2 'R'.

ENDFUNCTION.
