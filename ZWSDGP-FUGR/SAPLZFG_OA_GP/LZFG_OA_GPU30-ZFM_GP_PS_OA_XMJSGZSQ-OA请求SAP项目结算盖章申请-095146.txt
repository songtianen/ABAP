FUNCTION ZFM_GP_PS_OA_XMJSGZSQ.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(PS_PSPID) TYPE  PS_PSPID
*"     VALUE(ZKSFL) TYPE  ZE_ZKSFL
*"     VALUE(ZJSJE) TYPE  ZE_ZZJE
*"  TABLES
*"      OT_TAB STRUCTURE  ZSMM_017
*"----------------------------------------------------------------------
  ZFMDATASAVE1 'ZFM_GP_PS_OA_XMJSGZSQ'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.

  DATA: ES_RETURN     TYPE BAPIRETURN1,
        SYS_STATUS    TYPE BAPI_SYSTEM_STATUS_TEXT,
        SYSTEM_STATUS TYPE TABLE OF BAPI_SYSTEM_STATUS,
        USER_STATUS   TYPE TABLE OF BAPI_USER_STATUS,
        STATUS_RESULT TYPE TABLE OF BAPI_STATUS_RESULT,
        PJT_CHG       TYPE TABLE OF BAPI_BUS2001_CHG WITH HEADER LINE,
        PJT_UPD       TYPE TABLE OF BAPI_BUS2001_UPD WITH HEADER LINE,
        ET_RETURN     TYPE TABLE OF BAPIRET2 WITH HEADER LINE.
  DATA: OTTAB TYPE TABLE OF ZSMM_017 WITH HEADER LINE.
  DATA: ZXMZT TYPE  ZE_ZXMZT_OA VALUE '6'.

  CLEAR OT_TAB[].
  CALL FUNCTION 'ZFM_GP_PS_OA_XMZTBG'
    EXPORTING
      PS_PSPID = PS_PSPID
      ZXMZT    = ZXMZT
    TABLES
      OT_TAB   = OTTAB.
  LOOP AT OTTAB WHERE FLAG = 'N'.
    CLEAR OT_TAB.
    MOVE-CORRESPONDING OTTAB TO OT_TAB.
    APPEND OT_TAB.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDLOOP.

  CLEAR: ET_RETURN , ET_RETURN[] , PJT_UPD ,PJT_UPD[] , PJT_UPD , PJT_UPD[] .
  PJT_CHG-PROJECT_DEFINITION = PS_PSPID.
  CASE ZKSFL.
    WHEN '1'.
      PJT_CHG-USR05 = ZJSJE.
      APPEND PJT_CHG .
      PJT_UPD-USER_FIELD_QUAN2 = 'X'.
      APPEND PJT_UPD .
    WHEN '2'.
      PJT_CHG-USR06 = ZJSJE / 10.
      PJT_CHG-USE06 = 'CNY'.
      PJT_CHG-USR09 = SY-DATUM.
      APPEND PJT_CHG .
      PJT_UPD-USER_FIELD_CURR1 = 'X'.
      PJT_UPD-USER_FIELD_CUKY1 = 'X'.
      PJT_UPD-USER_FIELD_DATE2 = 'X'.
      APPEND PJT_UPD .
    WHEN OTHERS.
  ENDCASE.

  CALL FUNCTION 'BAPI_PS_INITIALIZATION'.

  CALL FUNCTION 'BAPI_BUS2001_CHANGE'
    EXPORTING
      I_PROJECT_DEFINITION     = PJT_CHG
      I_PROJECT_DEFINITION_UPD = PJT_UPD
    TABLES
      ET_RETURN                = ET_RETURN
*     EXTENSIONIN              =
*     EXTENSIONOUT             =
    .

  IF ES_RETURN-TYPE CA 'AEX'.
    OT_TAB-MESSAGE = ES_RETURN-MESSAGE.
  ENDIF.

  IF OT_TAB-MESSAGE IS INITIAL.
    CALL FUNCTION 'BAPI_PS_PRECOMMIT'.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        WAIT = 'X'.
    OT_TAB-FLAG = 'Y'.
    OT_TAB-MESSAGE = '状态更新成功'.
    APPEND OT_TAB.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
    OT_TAB-FLAG = 'N'.
    OT_TAB-MESSAGE = '更新开工日期失败'.
    APPEND OT_TAB.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.


  ZFMDATASAVE2 'R'.


ENDFUNCTION.
