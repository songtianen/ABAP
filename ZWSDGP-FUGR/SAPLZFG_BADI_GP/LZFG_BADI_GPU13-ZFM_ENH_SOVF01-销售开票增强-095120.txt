FUNCTION ZFM_ENH_SOVF01.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(CVBRK) LIKE  VBRK STRUCTURE  VBRK
*"     REFERENCE(DOC_NUMBER) LIKE  VBRK-VBELN OPTIONAL
*"  TABLES
*"      XACCIT STRUCTURE  ACCIT
*"      XACCCR STRUCTURE  ACCCR
*"      CVBRP STRUCTURE  VBRPVB OPTIONAL
*"      CKOMV STRUCTURE  KOMV
*"      CACCDPC STRUCTURE  ACCDPC OPTIONAL
*"      XACCFI STRUCTURE  ACCFI OPTIONAL
*"----------------------------------------------------------------------
  DATA:IT_VBELN TYPE TABLE OF LIPS_KEY WITH HEADER LINE,
       IT_LIPS  TYPE TABLE OF LIPS WITH HEADER LINE,
       IT_MATNR TYPE TABLE OF CCVX_MATNR WITH HEADER LINE.
  DATA:KBETR  TYPE KBETR,
       ZZWJZJ TYPE LIPS-ZZWJZJ,
       LFIMG  TYPE LFIMG,
       TABIX  TYPE SY-TABIX.
  CLEAR:IT_VBELN[],IT_MATNR[],ZZWJZJ,LFIMG.
*内存传值传输至ZFM_ENH_FI_DOCU_02
  EXPORT VBRK = CVBRK
         T_VBRP = CVBRP[]
         TO MEMORY ID 'MEMO_ZFM_ENH_FI_DOCU_02'.

*过账
  RETURN.
  BREAK DONGPZ.
  IF CVBRK-SFAKN IS INITIAL
    AND CVBRK-FKSTO IS INITIAL.
    CHECK CVBRP[] IS NOT INITIAL.
*查找交货单
    SELECT *
      INTO TABLE IT_LIPS
      FROM LIPS
      FOR ALL ENTRIES IN CVBRP
      WHERE VBELN = CVBRP-VGBEL
      AND   POSNR = CVBRP-VGPOS.
    IF SY-SUBRC EQ 0.
      SORT IT_LIPS BY VBELN POSNR.
*取尺寸明细
      SELECT *
        INTO TABLE @DATA(IT_LIPSITEM)
        FROM ZVSDLIPS_ITEM
        FOR ALL ENTRIES IN @IT_LIPS
        WHERE VBELN = @IT_LIPS-VBELN
        AND   POSNR = @IT_LIPS-POSNR.
      SORT IT_LIPSITEM BY ZPCDH VBELN POSNR.
    ENDIF.

*先找到物料和合同
    LOOP AT CVBRP.
      CLEAR:IT_MATNR,IT_VBELN.
      IT_VBELN-VBELN = CVBRP-AUBEL.
      IT_VBELN-POSNR = CVBRP-AUPOS.
      IT_MATNR-MATNR = CVBRP-MATNR.
      COLLECT:IT_MATNR,IT_VBELN.
    ENDLOOP.
    IF IT_MATNR[] IS NOT INITIAL.
      SORT IT_MATNR BY MATNR.
      SELECT *
        INTO TABLE @DATA(IT_MARA)
        FROM MARA
        FOR ALL ENTRIES IN @IT_MATNR
        WHERE MATNR = @IT_MATNR-MATNR.
      SORT IT_MARA BY MATNR.
    ENDIF.
    DELETE IT_VBELN WHERE VBELN IS INITIAL
    OR POSNR IS INITIAL.
    IF IT_VBELN[] IS NOT INITIAL.
      SORT IT_VBELN BY VBELN POSNR.
      SELECT *
        INTO TABLE @DATA(IT_VBAP)
        FROM VBAP
        FOR ALL ENTRIES IN @IT_VBELN
        WHERE VBELN = @IT_VBELN-VBELN
        AND   POSNR = @IT_VBELN-POSNR.
      IF SY-SUBRC EQ 0."根据合同号找排产
        SORT IT_VBAP BY VGBEL VGPOS.
        SELECT *
          INTO TABLE @DATA(IT_ZTPP205)
          FROM ZTPP_205
          FOR ALL ENTRIES IN @IT_VBAP
          WHERE VBELN = @IT_VBAP-VGBEL
          AND   POSNR = @IT_VBAP-VGPOS
          AND   DEL NE 'X'
          AND   ZADUIT = 'T'.
        IF SY-SUBRC EQ 0.
          SELECT *
            INTO TABLE @DATA(IT_ZTPP205B)
            FROM ZTPP_205B
            FOR ALL ENTRIES IN @IT_ZTPP205
            WHERE ZPCDH = @IT_ZTPP205-ZPCDH.
          SORT IT_ZTPP205B BY ZPCDH.
        ENDIF.
      ENDIF.
      SORT IT_VBAP BY VBELN POSNR.
    ENDIF.
*将金额汇总到交货单
    LOOP AT IT_LIPS.
      CLEAR:IT_LIPS-ZZWJZJ.
      READ TABLE IT_VBAP INTO DATA(WA_VBAP) WITH KEY VBELN = IT_LIPS-VGBEL
                                                     POSNR = IT_LIPS-VGPOS
                                                     BINARY SEARCH.
      IF SY-SUBRC EQ 0.
        LOOP AT IT_ZTPP205 INTO DATA(WA_ZTPP205) WHERE VBELN = WA_VBAP-VGBEL
                                                   AND POSNR = WA_VBAP-VGPOS.
          LOOP AT IT_ZTPP205B INTO DATA(WA_ZTPP205B) WHERE ZPCDH = WA_ZTPP205-ZPCDH.
            ZZWJZJ = ZZWJZJ + WA_ZTPP205B-ZZWJDJ.
          ENDLOOP.
*按排产单汇总明细
          LOOP AT IT_LIPSITEM INTO ZVSDLIPS_ITEM WHERE ZPCDH = WA_ZTPP205-ZPCDH.
            LFIMG = LFIMG + ZVSDLIPS_ITEM-ZCD * ZVSDLIPS_ITEM-ZZK.
          ENDLOOP.
        ENDLOOP.
      ENDIF.
      IT_LIPS-ZZWJZJ = ZZWJZJ * LFIMG.
      MODIFY IT_LIPS TRANSPORTING ZZWJZJ.
    ENDLOOP.
    SORT IT_LIPS BY VBELN POSNR.
    LOOP AT CVBRP.
      READ TABLE IT_MARA INTO DATA(WA_MARA) WITH KEY MATNR = CVBRP-MATNR BINARY SEARCH.
      CASE WA_MARA-MATKL.
        WHEN 'B0201' OR 'B0202' OR 'B0203' OR 'B0204'.
          READ TABLE IT_LIPS WITH KEY VBELN = CVBRP-VGBEL
                                      POSNR = CVBRP-VGPOS
                                      BINARY SEARCH.
          IF SY-SUBRC EQ 0
            AND IT_LIPS-ZZWJZJ GT 0.
            IF IT_LIPS-LFIMG GT 0.
              KBETR = IT_LIPS-ZZWJZJ / IT_LIPS-LFIMG.
            ENDIF.
            READ TABLE CKOMV WITH KEY KPOSN = CVBRP-POSNR
                                      KSCHL = 'ZPR0'
                                      KINAK = ''.
            TABIX = SY-TABIX.
            IF SY-SUBRC = 0.
              CKOMV-KBETR = KBETR.
              CKOMV-KWERT = IT_LIPS-ZZWJZJ .
              MODIFY CKOMV INDEX TABIX TRANSPORTING KBETR KWERT.
            ELSE.
            ENDIF.
          ENDIF.
      ENDCASE.
    ENDLOOP.
  ENDIF.
*更新折弯件价格
  IF IT_LIPS[] IS NOT INITIAL.
    CALL FUNCTION 'ZFM_ENH_UPDLIPS' IN UPDATE TASK
      TABLES
        T_LIPS = IT_LIPS.
  ENDIF.


ENDFUNCTION.
