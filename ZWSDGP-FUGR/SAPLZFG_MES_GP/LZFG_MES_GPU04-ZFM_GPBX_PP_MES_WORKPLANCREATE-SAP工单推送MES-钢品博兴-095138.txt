FUNCTION ZFM_GPBX_PP_MES_WORKPLANCREATE.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     REFERENCE(IN_TAB) TYPE  ZSPP_213
*"  EXPORTING
*"     REFERENCE(RTYPE) TYPE  BAPI_MTYPE
*"     REFERENCE(RTMSG) TYPE  BAPI_MSG
*"     REFERENCE(P_OUTPUT) TYPE  STRING
*"     REFERENCE(P_STATUS) TYPE  I
*"     REFERENCE(P_RESULT) TYPE  STRING
*"----------------------------------------------------------------------
  ZFMDATASAVE1 'ZFM_GPBX_PP_MES_WORKPLANCREATE'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.

  TYPES: BEGIN OF T_TOKEN,
           LOGIN_ACCOUNT TYPE STRING,
           LOGIN_PWD     TYPE STRING,
         END OF T_TOKEN.
  TYPES: BEGIN OF T_TOKEN_RE,
           STATUS_CODE TYPE I,
         END OF T_TOKEN_RE.
  DATA:BEGIN OF MESHEAD OCCURS 0,
         NAME  TYPE STRING,
         VALUE TYPE STRING,
       END OF MESHEAD.
  DATA: ITOKEN   TYPE T_TOKEN,
        ITOKENRE TYPE T_TOKEN_RE.
  DATA:
    MES_WORKPLANCREATE_URL   TYPE STRING, " VALUE 'http://192.168.12.233:1270/gpmes/pub/con/create', " 张延成测试地址  22.09.2022 12:19:31 by kkw
    MES_WORKPLANCREATE_STR   TYPE STRING,
    MES_WORKPLANCREATERE_STR TYPE STRING,
    MES_WORKPLANCREATE_MSG   TYPE STRING,
    MES_WORKPLANCREATE_STA   TYPE I.
  DATA: GS_TAB  TYPE ZSPP_213,
        GT_TAB4 TYPE TABLE OF ZSPP_214,
        GS_TAB4 LIKE LINE OF GT_TAB4,
        GT_TAB5 TYPE TABLE OF ZSPP_215,
        GS_TAB5 LIKE LINE OF GT_TAB5.
  DATA: REF_DESCR TYPE REF TO CL_ABAP_STRUCTDESCR.
  FIELD-SYMBOLS:<FS> TYPE ANY.

  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GPBX_PP_MES_WORKPLANCREATE' CHANGING MES_WORKPLANCREATE_URL.
  CHECK MES_WORKPLANCREATE_URL IS NOT INITIAL.


  " 对每个字段去空格  20.09.2022 09:37:13 by kkw
  REF_DESCR ?= CL_ABAP_TYPEDESCR=>DESCRIBE_BY_DATA( GS_TAB ).
  DATA(CONT) = LINES( REF_DESCR->COMPONENTS ) - 2.
  REF_DESCR ?= CL_ABAP_TYPEDESCR=>DESCRIBE_BY_DATA( GS_TAB4 ).
  DATA(CONT4) = LINES( REF_DESCR->COMPONENTS ).
  REF_DESCR ?= CL_ABAP_TYPEDESCR=>DESCRIBE_BY_DATA( GS_TAB5 ).
  DATA(CONT5) = LINES( REF_DESCR->COMPONENTS ).
  CLEAR:GS_TAB,GS_TAB4,GT_TAB4,GS_TAB5,GT_TAB5.
  GS_TAB = IN_TAB.
  SELECT SINGLE ZZL1
    INTO GS_TAB-WGBEZ
    FROM MARA
    WHERE MATNR = GS_TAB-GCID.
  DO CONT TIMES.
    ASSIGN COMPONENT SY-INDEX OF STRUCTURE GS_TAB TO <FS>.
    IF SY-SUBRC EQ 0 AND <FS> IS NOT INITIAL.
      CONDENSE <FS> NO-GAPS.
    ENDIF.
  ENDDO.
  LOOP AT GS_TAB-INGREDIENTS INTO GS_TAB4.
    DO CONT4 TIMES.
      ASSIGN COMPONENT SY-INDEX OF STRUCTURE GS_TAB4 TO <FS>.
      IF SY-SUBRC EQ 0 AND <FS> IS NOT INITIAL.
        CONDENSE <FS> NO-GAPS.
      ENDIF.
    ENDDO.
    APPEND GS_TAB4 TO GT_TAB4.
  ENDLOOP.
  LOOP AT GS_TAB-DETAILS INTO GS_TAB5.
    DO CONT5 TIMES.
      ASSIGN COMPONENT SY-INDEX OF STRUCTURE GS_TAB5 TO <FS>.
      IF SY-SUBRC EQ 0 AND <FS> IS NOT INITIAL.
        CONDENSE <FS> NO-GAPS.
      ENDIF.
    ENDDO.
********ADD BY DONGPZ BEGIN AT 22.12.2022 10:59:26
*根据工单取工作中心确定线边库
    SELECT SINGLE *
      INTO @DATA(WA_206)
      FROM ZTPP_206
      WHERE AUFNR = @GS_TAB-ORDERNO.
    IF WA_206-ARBPL IS NOT INITIAL.
      SELECT SINGLE ZXBK
        INTO GS_TAB5-ZXBK
        FROM ZTPP212
        WHERE WERKS = GS_TAB-FACTORY
        AND   ARBPL = WA_206-ARBPL.
    ENDIF.

********ADD BY DONGPZ END AT 22.12.2022 10:59:26
    APPEND GS_TAB5 TO GT_TAB5.
  ENDLOOP.
  IF GT_TAB4 IS NOT INITIAL.
    GS_TAB-INGREDIENTS = GT_TAB4.
  ENDIF.

  IF GT_TAB5 IS NOT INITIAL.
    GS_TAB-DETAILS = GT_TAB5.
  ENDIF.

  "调用mes计划单创建接口
  MES_WORKPLANCREATE_STR = /UI2/CL_JSON=>SERIALIZE( DATA = GS_TAB  COMPRESS = ABAP_FALSE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  P_OUTPUT = MES_WORKPLANCREATE_STR.

  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GPBX_PP_MES_WORKPLANCREATE' CHANGING MES_WORKPLANCREATE_URL.
  CHECK MES_WORKPLANCREATE_URL IS NOT INITIAL.

  PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING MES_WORKPLANCREATE_URL .

  CALL FUNCTION 'ZFMS_15_HTTP'
    EXPORTING
      INPUT     = MES_WORKPLANCREATE_STR
      URL       = MES_WORKPLANCREATE_URL
      REQMETHOD = 'POST' "HTTP 方法
      HTTP1_1   = 'X' "协议1.1/1.0
    IMPORTING
      OUTPUT    = MES_WORKPLANCREATERE_STR "返回JSON报文
      RTMSG     = MES_WORKPLANCREATE_MSG "消息
      STATUS    = MES_WORKPLANCREATE_STA "HTTP状态
    EXCEPTIONS
      OTHERS    = 1.
*  CHECK mes_workplancreate_sta = '200'.
  CLEAR ITOKENRE.
  /UI2/CL_JSON=>DESERIALIZE( EXPORTING JSON = MES_WORKPLANCREATERE_STR PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE CHANGING DATA = ITOKENRE ).
  P_RESULT = MES_WORKPLANCREATERE_STR.
  P_STATUS = MES_WORKPLANCREATE_STA.
  RTYPE = ITOKENRE-STATUS_CODE.
  RTMSG = ITOKENRE-STATUS_CODE.

  ZFMDATASAVE2 'R'.




ENDFUNCTION.
