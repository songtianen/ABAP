FUNCTION ZFM_GP_MM_OA_PDGZ.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(IT_HEAD) TYPE  ZWMS016_HEAD
*"  EXPORTING
*"     VALUE(RTYPE) TYPE  BAPI_MTYPE
*"     VALUE(RTMSG) TYPE  BAPI_MSG
*"     VALUE(MBLNR1) TYPE  MBLNR
*"     VALUE(MBLNR2) TYPE  MBLNR
*"     VALUE(MJAHR1) TYPE  MJAHR
*"     VALUE(MJAHR2) TYPE  MJAHR
*"     VALUE(MBLNR3) TYPE  MBLNR
*"     VALUE(MJAHR3) TYPE  MJAHR
*"     VALUE(MBLNR4) TYPE  MBLNR
*"     VALUE(MJAHR4) TYPE  MJAHR
*"  TABLES
*"      IT_ITEM STRUCTURE  ZWMS016_ITEM_D
*"----------------------------------------------------------------------

  ZFMDATASAVE1 'ZFM_GP_MM_OA_PDGZ'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.
  CALL FUNCTION 'ZFM_GP_WMS_POST'
    EXPORTING
      IT_HEAD = IT_HEAD
      FMNAM   = 'ZFM_GP_MM_OA_PDGZ'
    IMPORTING
      RTYPE   = RTYPE
      RTMSG   = RTMSG
      MBLNR1  = MBLNR1
      MJAHR1  = MJAHR1
      MBLNR2  = MBLNR2
      MJAHR2  = MJAHR2
      MBLNR3  = MBLNR3
      MJAHR3  = MJAHR3
      MBLNR4  = MBLNR4
      MJAHR4  = MJAHR4
    TABLES
      IT_ITEM = IT_ITEM.
  ZFMDATASAVE2 'R'.
  RETURN.



  DATA: P_TYPE1   TYPE BAPI_MTYPE,
        P_TYPE2   TYPE BAPI_MTYPE,
        P_MSG1    TYPE BAPI_MSG,
        P_MSG2    TYPE BAPI_MSG,
        MBLNR     TYPE MBLNR,
        MJAHR     TYPE MJAHR,
        IT_MIGO_S TYPE TABLE OF ZSFMS_MIGOPOST WITH HEADER LINE,
        IT_MIGO_H TYPE TABLE OF ZSFMS_MIGOPOST WITH HEADER LINE,
        IT_MIGO   TYPE TABLE OF ZSFMS_MIGOPOST WITH HEADER LINE,
        ITEM_S    TYPE STANDARD TABLE OF ZWMS016_ITEM_D,
        ITEM_H    TYPE STANDARD TABLE OF ZWMS016_ITEM_D,
        BKTXT_S   TYPE BKTXT,
        BKTXT_H   TYPE BKTXT,
        BWART_S   TYPE BWART VALUE '701',
        BWART_H   TYPE BWART VALUE '702'.
  IF IT_HEAD IS INITIAL.
    RTYPE = 'E'.
    RTMSG = '传入表头为空'.
    EXIT.
  ENDIF.
  DELETE IT_ITEM[] WHERE ZWCYSL =    0.
  IF IT_ITEM[] IS INITIAL.
    RTYPE = 'E'.
    RTMSG = '传入表体为空'.
    EXIT.
  ENDIF.
  LOOP AT IT_ITEM INTO DATA(LS_WA).
    LS_WA-MATNR = |{ LS_WA-MATNR ALPHA = IN }|.
    MODIFY IT_ITEM FROM LS_WA INDEX SY-TABIX TRANSPORTING MATNR.
    CLEAR LS_WA.
  ENDLOOP.
  LOOP AT IT_ITEM INTO DATA(WA).
    IF WA-ZWCYSL > 0.
      APPEND WA TO ITEM_S.
    ELSE.
      APPEND WA TO ITEM_H.
    ENDIF.
    CLEAR WA.
  ENDLOOP.
  LOOP AT ITEM_S INTO DATA(WA_S).
    IT_MIGO_S-MATNR = WA_S-MATNR.
    IT_MIGO_S-MENGE = WA_S-ZWCYSL.
    IT_MIGO_S-BWART = BWART_S.
    IT_MIGO_S-CHARG = WA_S-CHARG.
    IT_MIGO_S-WERKS = WA_S-ZWERKS.
    IT_MIGO_S-LGORT = WA_S-ZLGORT.
    APPEND IT_MIGO_S.
    CLEAR WA_S.
  ENDLOOP.
  LOOP AT ITEM_H INTO DATA(WA_H).
    IT_MIGO_H-MATNR = WA_H-MATNR.
    IT_MIGO_H-MENGE = WA_H-ZWCYSL.
    IT_MIGO_H-BWART = BWART_H.
    IT_MIGO_H-CHARG = WA_H-CHARG.
    IT_MIGO_H-WERKS = WA_H-ZWERKS.
    IT_MIGO_H-LGORT = WA_H-ZLGORT.
    APPEND IT_MIGO_H.
    CLEAR WA_H.
  ENDLOOP.
  APPEND LINES OF IT_MIGO_S TO IT_MIGO.
  APPEND LINES OF IT_MIGO_H TO IT_MIGO.
  LOOP AT IT_MIGO.
    SELECT SINGLE XCHAR INTO @DATA(LS_XCHAR)
    FROM MARC
    WHERE MATNR = @IT_MIGO-MATNR
    AND WERKS = @IT_MIGO-WERKS.
    IF LS_XCHAR IS NOT INITIAL AND IT_MIGO-CHARG IS INITIAL.
      RTYPE = 'E'.
      RTMSG = |{ IT_MIGO-MATNR }无批次号|.
      EXIT.
    ENDIF.
    CLEAR IT_MIGO.
  ENDLOOP.

  IF IT_MIGO_S[] IS NOT INITIAL.
    BKTXT_S = IT_HEAD-ZWNO.
    CALL FUNCTION 'ZFMS_01_MIGOPOST'
      EXPORTING
        BUDAT  = It_head-BLDAT
        "bldat  = It_head-bldat
        BKTXT  = BKTXT_s
        "XBLNR  = XBLNR
        CODE   = '06'
        BWART  = BWART_S
      IMPORTING
        RTYPE  = P_TYPE1
        RTMSG  = P_MSG1
        MBLNR  = MBLNR1
        MJAHR  = MJAHR1
      TABLES
        ITEM   = IT_MIGO_s
      EXCEPTIONS
        OTHERS = 1.
    IF P_TYPE1 = 'S'.
      RTYPE = 'S'.
      RTMSG = '盘盈成功'.
    ELSE.
      RTYPE = 'E'.
      RTMSG = P_MSG1.
    ENDIF.
  ENDIF.
  IF IT_MIGO_H[] IS NOT INITIAL.
    LOOP AT IT_MIGO_H.
      IT_MIGO_H-MENGE = ABS( IT_MIGO_H-MENGE ).
      MODIFY IT_MIGO_H.
    ENDLOOP.
    BKTXT_H = IT_HEAD-ZWNO.
    CALL FUNCTION 'ZFMS_01_MIGOPOST'
      EXPORTING
        BUDAT  = It_head-BLDAT
        "bldat  = It_head-bldat
        BKTXT  = BKTXT_h
        "XBLNR  = XBLNR
        CODE   = '06'
        BWART  = BWART_H
      IMPORTING
        RTYPE  = P_TYPE2
        RTMSG  = P_MSG2
        MBLNR  = MBLNR2
        MJAHR  = MJAHR2
      TABLES
        ITEM   = IT_MIGO_h
      EXCEPTIONS
        OTHERS = 1.
    IF P_TYPE2 = 'S'.
      RTYPE = 'S'.
      RTMSG = '盘亏成功' && RTMSG.
    ELSE.
      RTYPE = 'E'.
      RTMSG = P_MSG2 && P_MSG1.
    ENDIF.
  ENDIF.




  ZFMDATASAVE2 'R'.

ENDFUNCTION.
