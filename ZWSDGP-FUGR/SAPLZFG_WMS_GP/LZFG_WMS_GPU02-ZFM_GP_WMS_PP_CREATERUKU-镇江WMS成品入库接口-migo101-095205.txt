FUNCTION ZFM_GP_WMS_PP_CREATERUKU.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(CORRELATIONNO) TYPE  CHAR20 OPTIONAL
*"     VALUE(CUSTOMERCODE) TYPE  KUNNR OPTIONAL
*"     VALUE(ZTYPE) TYPE  CHAR10 OPTIONAL
*"     VALUE(WAREHOUSE) TYPE  LGORT_D OPTIONAL
*"     VALUE(WAREHOUSENAME) TYPE  LGOBE OPTIONAL
*"     VALUE(WORKSHOP) TYPE  ZE_CJDESC OPTIONAL
*"     VALUE(ORGANIZATION) TYPE  WERKS_D
*"     VALUE(ORGANIZATIONNAME) TYPE  NAME1 OPTIONAL
*"     VALUE(PROJECTNO) TYPE  CHAR100 OPTIONAL
*"     VALUE(PROJECTNAME) TYPE  CHAR100 OPTIONAL
*"     VALUE(SINGLECODE) TYPE  CHAR10 OPTIONAL
*"     VALUE(SINGLEDATETIME) TYPE  DATS OPTIONAL
*"  EXPORTING
*"     VALUE(RTYPE) TYPE  BAPI_MTYPE
*"     VALUE(RTMSG) TYPE  BAPI_MSG
*"  TABLES
*"      IN_TAB STRUCTURE  ZSPP_212
*"      OUT_TAB STRUCTURE  ZSPP_210
*"----------------------------------------------------------------------
  ZFMDATASAVE1 'ZFM_GP_WMS_PP_CREATERUKU'.
  ZFMDATASAVE2 'B'.
  COMMIT WORK.
  "bapi 参数
  DATA:LS_HEADER           TYPE          BAPI2017_GM_HEAD_01,
       LS_CODE             TYPE          BAPI2017_GM_CODE,
       LT_ITEM             TYPE TABLE OF BAPI2017_GM_ITEM_CREATE,
       LS_ITEM             TYPE          BAPI2017_GM_ITEM_CREATE,
       LT_RETURN           TYPE TABLE OF BAPIRET2,
       LS_RETURN           TYPE          BAPIRET2,
       LV_MATERIALDOCUMENT TYPE BAPI2017_GM_HEAD_RET-MAT_DOC,
       LV_MATDOCUMENTYEAR  TYPE BAPI2017_GM_HEAD_RET-DOC_YEAR.
  DATA MATNR1 TYPE MATNR.

  IF LINES( IN_TAB ) NE 1.
    FILL_MSG 'F' '成品入库明细只能是一行' 'X'.
  ENDIF.

  LS_CODE = '02'.
  "准备抬头数据
  LS_HEADER-PSTNG_DATE    = SY-DATUM.
  LS_HEADER-DOC_DATE      = SY-DATUM.             "凭证中的凭证日期
  LS_HEADER-PR_UNAME      = SINGLECODE.              "用户名
  LS_HEADER-HEADER_TXT = '镇江WMS'.
  CLEAR:LS_ITEM,LT_ITEM.
  "行项目数据
  READ TABLE IN_TAB INDEX 1.
*  DATA(AUFNR) = IN_TAB-SOURCENO.
  LS_ITEM-ORDERID    =    |{ IN_TAB-SOURCENO ALPHA = IN }|.         "工单号
*  LS_ITEM-ORDERID    =    |{ AUFNR ALPHA = IN }|.         "工单号

  SELECT COUNT( * ) FROM AFKO WHERE AUFNR = LS_ITEM-ORDERID.
  IF SY-SUBRC NE 0.
    DATA(MSG) = 'SAP查无工单:' && LS_ITEM-ORDERID.
    FILL_MSG 'F' MSG 'X'.
  ENDIF.

  CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
    EXPORTING
      INPUT  = IN_TAB-PRODUCTCODE
    IMPORTING
      OUTPUT = MATNR1
*     EXCEPTIONS
*     LENGTH_ERROR       = 1
*     OTHERS = 2
    .

  LS_ITEM-MATERIAL   =    MATNR1.         "物料编号
  LS_ITEM-PLANT      =    ORGANIZATION.         "工厂
  LS_ITEM-STGE_LOC   =    WAREHOUSE.         "库存地点
  LS_ITEM-BATCH      =    ''.         "批次号
  LS_ITEM-ENTRY_QNT  =    IN_TAB-QTY.         "以录入项单位表示的数量
  LS_ITEM-ENTRY_UOM  =    IN_TAB-UNIT.
*  ls_item-move_stloc =    warehouse.         "收货库存地点
*  ls_item-move_batch =    ''.         "收货批次
*  ls_item-stck_type  = '2' . "质检状态
  LS_ITEM-MVT_IND    =    'F'.             "移动标识  ’B‘为采购收货  ’F ' 生产收货
  LS_ITEM-MOVE_TYPE  =    '101'.                 "移动类型
  APPEND LS_ITEM  TO LT_ITEM .

  CALL FUNCTION 'BAPI_GOODSMVT_CREATE'
    EXPORTING
      GOODSMVT_HEADER  = LS_HEADER
      GOODSMVT_CODE    = LS_CODE
    IMPORTING
      MATERIALDOCUMENT = LV_MATERIALDOCUMENT
      MATDOCUMENTYEAR  = LV_MATDOCUMENTYEAR
    TABLES
      GOODSMVT_ITEM    = LT_ITEM
      RETURN           = LT_RETURN.

  IF ( LINE_EXISTS( LT_RETURN[ TYPE = 'A' ] ) ) OR ( LINE_EXISTS( LT_RETURN[ TYPE = 'E' ] ) ) OR ( LINE_EXISTS( LT_RETURN[ TYPE = 'X' ] ) ).
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.

    DATA: LT_MSG_TAB TYPE ESP1_MESSAGE_TAB_TYPE,
          WA_MSG_TAB LIKE LINE OF LT_MSG_TAB.
    DATA:MSG1 TYPE BAPI_MSG.
    CLEAR MSG1.
    LOOP AT LT_RETURN INTO LS_RETURN WHERE TYPE CA 'AEX'.
      CONCATENATE '错误：' LS_RETURN-MESSAGE INTO MSG1.
    ENDLOOP.
    FILL_MSG 'F' MSG1 'X'.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        WAIT = 'X'.
    DATA(CC) = |'101生产收货成功,凭证号:'{ LV_MATERIALDOCUMENT }|.
    FILL_MSG 'S' CC ''.
  ENDIF.

  ZFMDATASAVE2 'R'.




ENDFUNCTION.
