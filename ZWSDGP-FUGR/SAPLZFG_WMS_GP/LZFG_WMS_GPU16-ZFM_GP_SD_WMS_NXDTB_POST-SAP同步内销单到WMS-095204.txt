FUNCTION ZFM_GP_SD_WMS_NXDTB_POST.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  EXPORTING
*"     VALUE(P_INPUT) TYPE  STRING
*"     VALUE(P_OUTPUT) TYPE  STRING
*"     VALUE(P_STATUS) TYPE  I
*"     VALUE(RTYPE) TYPE  CHAR20
*"     VALUE(RTMSG) TYPE  BAPI_MSG
*"  TABLES
*"      IN_TAB STRUCTURE  ZSSD252
*"----------------------------------------------------------------------

  ZFMDATASAVE1 'ZFM_GP_SD_WMS_NXDTB_POST'.
  ZFMDATASAVE2 'B'.
  TYPES: BEGIN OF T_DETAILLIST2,"明细
           PRODUCTCODE         TYPE  STRING,
           PKGNO               TYPE  STRING,
           QTY                 TYPE  STRING,
           BLOCKS              TYPE  STRING,
           UNIT                TYPE  STRING,
*           TARGETCONTRACTNO    TYPE  POSNR,
           TARGETCONTRACTNO    TYPE  STRING,
           TARGETCONTRACTNAME  TYPE  STRING,
           TARGETPROJECTNO     TYPE  STRING,
           TARGETPROJECTNAME   TYPE  STRING,
*           ORIGINCONTRACTNO    TYPE  POSNR,
           ORIGINCONTRACTNO    TYPE  STRING,
           ORIGINCONTRACTNAME  TYPE  STRING,
           ORIGINPROJECTNO     TYPE  STRING,
           ORIGINPROJECTNAME   TYPE  STRING,
           DETAILLINEOPERATION TYPE  STRING,
           REELNO              TYPE  STRING,
           SELFNUMBER          TYPE  STRING,
         END OF T_DETAILLIST2.
  TYPES: TT_DETAILLIST2 TYPE STANDARD TABLE OF T_DETAILLIST2 WITH DEFAULT KEY.
* 报文结构
  TYPES: BEGIN OF T_JSON1,
           CODE                     TYPE  STRING,
           PURCHASEORGANIZATION     TYPE  STRING,
           PURCHASEORGANIZATIONNAME TYPE  STRING,
           PURCHASEWAREHOUSE        TYPE  STRING,
           PURCHASEWAREHOUSENAME    TYPE  STRING,
           SELLORGANIZATION         TYPE  STRING,
           SELLORGANIZATIONNAME     TYPE  STRING,
           SELLWAREHOUSE            TYPE  STRING,
           SELLWAREHOUSENAME        TYPE  STRING,
           SELLWORKSHOP             TYPE  STRING,
           TEMPORARYWAREHOUSE       TYPE  STRING,
           TEMPORARYWAREHOUSENAME   TYPE  STRING,
           SINGLE                   TYPE  STRING,
           SINGLEDATETIME           TYPE  STRING,
           OUTDATETIME              TYPE  STRING,
           DETAILLIST               TYPE  TT_DETAILLIST2,
         END OF T_JSON1.
*         返回报文结构
  TYPES: BEGIN OF T_JSON2,
           ID         TYPE STRING,
           ERROR_CODE TYPE STRING,
           STATUS     TYPE STRING,
           MSG        TYPE STRING,
           PDF_URL    TYPE STRING,
           PRINT_URL  TYPE STRING,
         END OF T_JSON2.

  DATA:ITAB      TYPE T_JSON1,
       ITAB_DE   TYPE TABLE OF T_DETAILLIST2 WITH HEADER LINE,
       ITRE      TYPE T_JSON2,
       WMSURL    TYPE STRING,
       WMSMSG    TYPE STRING,
       WMSSTA    TYPE I,
       WMSSTR_RE TYPE STRING.
  DATA: POSNR_MB TYPE POSNR,
        POSNR_Y  TYPE POSNR,
        ERPJG_CG TYPE ZSAP2WMS-ERPJG,
        ERPJG_XS TYPE ZSAP2WMS-ERPJG,
*增加临时库存地编码及临时库存地名称，取值为SAP的值，WMS要求_By_qidawei_2022-12-30
        ZLGORT   TYPE T001L-LGORT,
        ZLGOBE   TYPE T001L-LGOBE,
*将制单人的编码去掉前边的两位数字"80"，增加取值字段，WMS要求_By_qidawei_2022-12-30
        ZSINGLE  TYPE ZTSD208-KUNNR,
        KUNNR    TYPE KUNNR.
  RANGES: S_MATKL FOR MARA-MATKL.
  CLEAR:ITAB,ITRE,ITAB_DE[],S_MATKL[].
  CHECK IN_TAB[] IS NOT INITIAL.
  S_MATKL = 'IEQE0201'. APPEND S_MATKL.
  S_MATKL = 'IEQE0202'. APPEND S_MATKL.
  S_MATKL = 'IEQE0203'. APPEND S_MATKL.
  S_MATKL = 'IEQE0204'. APPEND S_MATKL.
  S_MATKL = 'IEQE0205'. APPEND S_MATKL.
  S_MATKL = 'IEQE0206'. APPEND S_MATKL.
  S_MATKL = 'IEQE0207'. APPEND S_MATKL.
  S_MATKL = 'IEQE0212'. APPEND S_MATKL.
  S_MATKL = 'IEQE0216'. APPEND S_MATKL.
  S_MATKL = 'IEQE0217'. APPEND S_MATKL.


  SELECT
    MATNR,
    MATKL
    INTO TABLE @DATA(IT_MARA)
    FROM MARA
    FOR ALL ENTRIES IN @IN_TAB
    WHERE MARA~MATNR = @IN_TAB-MATNR
     .
  SORT IT_MARA BY MATNR.
*填充明细
  LOOP AT IN_TAB.
    ITAB_DE-PRODUCTCODE         = IN_TAB-MATNR    .
    ITAB_DE-PKGNO               = IN_TAB-ZBAOH    .
    ITAB_DE-QTY                 = IN_TAB-LFIMG    .
    CONDENSE ITAB_DE-QTY.
    ITAB_DE-BLOCKS              = IN_TAB-ZKS    .
    CONDENSE ITAB_DE-BLOCKS.
    ITAB_DE-UNIT                = IN_TAB-MEINS    .
    POSNR_MB                    = IN_TAB-POSNR_MB   .
    ITAB_DE-TARGETCONTRACTNO    = POSNR_MB          .
    PERFORM DELZERO(ZPUBFORM) CHANGING  ITAB_DE-TARGETCONTRACTNO.
    CONDENSE ITAB_DE-TARGETCONTRACTNO.
    ITAB_DE-TARGETCONTRACTNAME  = IN_TAB-VBELN_MB   .
    ITAB_DE-TARGETPROJECTNO     = IN_TAB-PSPHI_MB   .
    ITAB_DE-TARGETPROJECTNAME   = IN_TAB-POST1_MB   .
    ITAB_DE-SELFNUMBER   = IN_TAB-ZZBH   .
    ITAB_DE-REELNO   = IN_TAB-ZJH   .
    POSNR_Y = IN_TAB-POSNR_Y                        .
    ITAB_DE-ORIGINCONTRACTNO    = POSNR_Y           .
    PERFORM DELZERO(ZPUBFORM) CHANGING  ITAB_DE-ORIGINCONTRACTNO.
    CONDENSE ITAB_DE-ORIGINCONTRACTNO.
    ITAB_DE-ORIGINCONTRACTNAME  = IN_TAB-VBELN_Y    .
    ITAB_DE-ORIGINPROJECTNO     = IN_TAB-PSPHI_Y    .
    ITAB_DE-ORIGINPROJECTNAME   = IN_TAB-POST1_Y    .
    ITAB_DE-DETAILLINEOPERATION = IN_TAB-ZHCZ       .
    READ TABLE IT_MARA INTO DATA(WA_MARA) WITH KEY MATNR = IN_TAB-MATNR BINARY SEARCH.
    IF SY-SUBRC = 0 AND WA_MARA-MATKL IN S_MATKL.
      ITAB_DE-ORIGINCONTRACTNAME = ''.
      ITAB_DE-ORIGINCONTRACTNO = ''.
    ENDIF.
    APPEND ITAB_DE.
  ENDLOOP.
*  填充抬头
  READ TABLE IN_TAB INDEX 1.
  ITAB-CODE                     = IN_TAB-VBELN  .
*  ITAB-PURCHASEORGANIZATION      = IN_TAB-VKORG_CG .
*  ITAB-PURCHASEORGANIZATIONNAME  = IN_TAB-VKORGNAME_CG .

  SELECT SINGLE
    ZSAP2WMS~ERPLGORT
    ZSAP2WMS~ERPLGOBE
    ZSAP2WMS~ERPJG
    ZSAP2WMS~ERPJGMS
    INTO ( ITAB-PURCHASEWAREHOUSE , ITAB-PURCHASEWAREHOUSENAME , ERPJG_CG , ITAB-PURCHASEORGANIZATIONNAME  )
    FROM ZSAP2WMS
    WHERE ZSAP2WMS~LGORT = IN_TAB-LGORT_CG
     AND  ZSAP2WMS~WERKS = IN_TAB-WERKS_CG
     .
  ITAB-PURCHASEORGANIZATION    = ERPJG_CG.
  CONDENSE ITAB-PURCHASEORGANIZATION.
*  ITAB-PURCHASEWAREHOUSE        = IN_TAB-LGORT_CG .
*  ITAB-PURCHASEWAREHOUSENAME    = IN_TAB-LGORTNAME_CG .

*  ITAB-SELLORGANIZATION         = IN_TAB-VKORG_XS .
*  ITAB-SELLORGANIZATIONNAME      = IN_TAB-VKORGNAME_XS .
*  ITAB-SELLWAREHOUSE            = IN_TAB-LGORT_XS .
*  ITAB-SELLWAREHOUSENAME        = IN_TAB-LGORTNAME_XS .

  SELECT SINGLE
    ZSAP2WMS~ERPLGORT
    ZSAP2WMS~ERPLGOBE
    ZSAP2WMS~ERPJG
    ZSAP2WMS~ERPJGMS
    INTO ( ITAB-SELLWAREHOUSE  , ITAB-SELLWAREHOUSENAME  , ERPJG_XS , ITAB-SELLORGANIZATIONNAME  )
    FROM ZSAP2WMS
    WHERE ZSAP2WMS~LGORT = IN_TAB-LGORT_XS
     AND  ZSAP2WMS~WERKS = IN_TAB-WERKS_XS
     .
  ITAB-SELLORGANIZATION    = ERPJG_XS.
  CONDENSE ITAB-SELLORGANIZATION.

  ITAB-SELLWORKSHOP	            =	IN_TAB-ZCHEJIAN	.

*  ITAB-TEMPORARYWAREHOUSE        = IN_TAB-LGORT_LS .
*  ITAB-TEMPORARYWAREHOUSENAME    = IN_TAB-LGORTNAME_LS .

*增加临时库存地编码及临时库存地名称，取值为SAP的值，WMS要求_By_qidawei_2022-12-30
  SELECT SINGLE
    T001L~LGORT
    T001L~LGOBE
    INTO ( ZLGORT  , ZLGOBE  )
    FROM T001L
    WHERE T001L~LGORT = IN_TAB-LGORT_CG
     AND  T001L~WERKS = IN_TAB-WERKS_CG
     .

*将制单人的编码去掉前边的两位数字"80"，增加取值字段，WMS要求_By_qidawei_2022-12-30
  ZSINGLE = IN_TAB-ERNAM+2(4).
  ITAB-SINGLE                   = ZSINGLE .
  ITAB-SINGLEDATETIME           = IN_TAB-ERDAT  .

*增加临时库存地编码及临时库存地名称，取值为SAP的值，WMS要求_By_qidawei_2022-12-30
  ITAB-TEMPORARYWAREHOUSE       = ZLGORT .
  ITAB-TEMPORARYWAREHOUSENAME   = ZLGOBE .



*  SELECT SINGLE
*    ZTSD208~KUNNR
*    KNA1~NAME1
*    INTO ( KUNNR , ITAB-SINGLEDATETIME  )
*    FROM ZTSD208
*    INNER JOIN KNA1 ON KNA1~KUNNR = ZTSD208~KUNNR
*    WHERE ZTSD208~ERNAM = IN_TAB-ERNAM
*     AND  ZTSD208~ZDEL <> 'X' .
*  .
*  ITAB-SINGLE                   = KUNNR+6(4)    .

  ITAB-OUTDATETIME              = IN_TAB-ZODT   .
  ITAB-DETAILLIST = ITAB_DE[].

*
  DATA(WMSSTR) = /UI2/CL_JSON=>SERIALIZE( DATA = ITAB  COMPRESS = ABAP_FALSE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
*
*  P_INPUT = WMSSTR.
*
  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GP_SD_WMS_NXDTB_POST' CHANGING WMSURL.
  IF WMSURL IS INITIAL.
    RTYPE = 'N'.
    RTMSG = '内销单同步WMS的URL未维护！'.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.
*调用函数HTTP
  P_INPUT = WMSSTR .
  PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING WMSURL.
  CALL FUNCTION 'ZFMS_15_HTTP'
    EXPORTING
      INPUT     = WMSSTR
      URL       = WMSURL
      REQMETHOD = 'POST' "HTTP 方法
      HTTP1_1   = 'X' "协议1.1/1.0
    IMPORTING
      OUTPUT    = WMSSTR_RE "返回JSON报文
      RTMSG     = WMSMSG "消息
      STATUS    = WMSSTA "HTTP状态
    EXCEPTIONS
      OTHERS    = 1.
*解析返回的json
  /UI2/CL_JSON=>DESERIALIZE( EXPORTING JSON = WMSSTR_RE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE CHANGING DATA = ITRE ).

  P_STATUS = WMSSTA.
  P_OUTPUT = WMSSTR_RE.
  RTYPE = ITRE-STATUS.
  RTMSG = ITRE-MSG.

  ZFMDATASAVE2 'R'.


ENDFUNCTION.
