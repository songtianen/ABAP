FUNCTION ZFM_GP_SD_WMS_FHTZTB_POST.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  EXPORTING
*"     VALUE(P_INPUT) TYPE  STRING
*"     VALUE(P_OUTPUT) TYPE  STRING
*"     VALUE(P_STATUS) TYPE  I
*"     VALUE(RTYPE) TYPE  BAPI_MTYPE
*"     VALUE(RTMSG) TYPE  BAPI_MSG
*"  TABLES
*"      INTAB1 STRUCTURE  ZSSD207
*"      INTAB2 STRUCTURE  ZSSD208
*"----------------------------------------------------------------------

  ZFMDATASAVE1 'ZFM_GP_SD_WMS_FHTZTB_POST'.
  ZFMDATASAVE2 'B'.

  TYPES: BEGIN OF DETAILLIST,
           CONTRACTNO          TYPE STRING, "销售合同 VBELN
           CONTRACTDETAILNO    TYPE STRING, "销售合同 POSNR
           ID                  TYPE STRING, "发货通知 POSNR
           PRODUCTCODE         TYPE STRING,
           PROJECTNO           TYPE STRING,
           PROJECTNAME         TYPE STRING,
           QTY                 TYPE STRING,
           UNIT                TYPE STRING,
           DETAILLINEOPERATION TYPE STRING,
           PKGNO               TYPE STRING,
           REELNO              TYPE STRING,
           SCHEDULINGNO        TYPE STRING,
         END OF DETAILLIST.

  TYPES: DETAIL_LIST TYPE STANDARD TABLE OF DETAILLIST WITH DEFAULT KEY.

  TYPES: BEGIN OF T_JSON1,
           CODE             TYPE STRING,
           TYPE             TYPE STRING,
           CUSTOMERCODE     TYPE STRING,
           CUSTOMERADDRESS  TYPE STRING,
           WAREHOUSE        TYPE STRING,
           WAREHOUSENAME    TYPE STRING,
           WORKSHOP         TYPE STRING,
           SINGLECODE       TYPE STRING,
           SINGLEDATETIME   TYPE STRING,
           ORGANIZATION     TYPE STRING,
           ORGANIZATIONNAME TYPE STRING,
           PLANARRIVALTIME  TYPE STRING,
           PROJECTNAME      TYPE STRING,
           PROJECTNO        TYPE STRING,
           CARNAME          TYPE STRING,
           CARPHONE         TYPE STRING,
           CARPLATE         TYPE STRING,
           CARRIERCODE      TYPE STRING,
           CARRIERNAME      TYPE STRING,
           KNOW             TYPE STRING,
           INORGANIZATION   TYPE STRING,
           INWAREHOUSE      TYPE STRING,
           INWAREHOUSENAME  TYPE STRING,
           SUPPLIERCODE     TYPE STRING,
           REMARK           TYPE STRING,
           DETAIL_LIST      TYPE DETAIL_LIST,
         END OF T_JSON1.

  TYPES: BEGIN OF T_JSON2,
           ID         TYPE STRING,
           ERROR_CODE TYPE STRING,
           STATUS     TYPE STRING,
           MSG        TYPE STRING,
           PDF_URL    TYPE STRING,
           PRINT_URL  TYPE STRING,
         END OF T_JSON2.

  DATA:ITAB      TYPE T_JSON1,
       LIST      TYPE TABLE OF DETAILLIST WITH HEADER LINE,
       ITRE      TYPE T_JSON2,
       WMSURL    TYPE STRING,
       WMSMSG    TYPE STRING,
       WMSSTA    TYPE I,
       WMSSTR_RE TYPE STRING.

  CHECK INTAB1[] IS NOT INITIAL.
  CHECK INTAB2[] IS NOT INITIAL.

  LOOP AT INTAB2.
    LIST-CONTRACTNO          = INTAB2-HTD  .
    LIST-CONTRACTDETAILNO    = INTAB2-HTDH .
    PERFORM DELZERO(ZPUBFORM) CHANGING LIST-CONTRACTDETAILNO.
    LIST-ID                  = INTAB2-FHDH .
    PERFORM DELZERO(ZPUBFORM) CHANGING LIST-ID .
    LIST-PRODUCTCODE         = INTAB2-MATNR .
    LIST-PROJECTNO           = INTAB2-PSPNR .
    PERFORM DELZERO(ZPUBFORM) CHANGING LIST-PROJECTNO .
    LIST-PROJECTNAME         = INTAB2-POST1 .
    LIST-QTY                 = INTAB2-KWMENG .
    LIST-UNIT                = INTAB2-VRKME .
*    LIST-DETAILLINEOPERATION = INTAB2- .
*    LIST-PKGNO               = INTAB2- .
*    LIST-REELNO              = INTAB2- .
*    LIST-SCHEDULINGNO        = INTAB2- .
    APPEND LIST.
  ENDLOOP.


  READ TABLE INTAB1 INDEX 1.
  ITAB-CODE               = INTAB1-VBELN  .
*  ITAB-TYPE               = INTAB1-AUART  .
  ITAB-TYPE               = 'FHTZ'  .
*  ITAB-CUSTOMERCODE       = INTAB1-KUNNR  .
  SELECT SINGLE
     ZTSD212~KUNNR
    INTO ITAB-CUSTOMERCODE
    FROM ZTSD212
    WHERE ZTSD212~PARTNER = INTAB1-KUNNR
     .
  PERFORM DELZERO(ZPUBFORM) CHANGING ITAB-CUSTOMERCODE  .
  CONDENSE ITAB-CUSTOMERCODE .
*  ITAB-CUSTOMERCODE       = 'C015268' .
  ITAB-CUSTOMERADDRESS    = INTAB1-BEZEI && '省'  && INTAB1-ORT01  && INTAB1-STR_SUPPL3 && INTAB1-LOCATION  .
*  ITAB-WAREHOUSE          = INTAB1-LGORT  .
*  ITAB-WAREHOUSENAME      = INTAB1-LGOBE  .
  SELECT SINGLE
    ZSAP2WMS~ERPLGORT
    ZSAP2WMS~ERPLGOBE
    INTO ( ITAB-WAREHOUSE , ITAB-WAREHOUSENAME )
    FROM ZSAP2WMS
    WHERE ZSAP2WMS~WERKS = INTAB1-WERKS
     AND  ZSAP2WMS~LGORT = INTAB1-LGORT
     .

*  ITAB-WORKSHOP           = INTAB1-  .
  SELECT SINGLE
    ZTSD208~KUNNR
    INTO @DATA(KUNNR)
    FROM ZTSD208
    WHERE ZTSD208~ERNAM = @INTAB1-ERNAM
     AND  ZTSD208~ZDEL <> 'X' .
     .
  ITAB-SINGLECODE              = KUNNR+6(4)    .
*  ITAB-SINGLECODE         = INTAB1-ERNAM  .

  ITAB-SINGLEDATETIME     = INTAB1-ERDAT && INTAB1-ERZET  .
*  ITAB-ORGANIZATION       = INTAB1-VKORG  .
  SELECT SINGLE
  ZTSD210~ZERPJG
  INTO ITAB-ORGANIZATION
  FROM ZTSD210
  WHERE ZTSD210~WERKS = INTAB1-WERKS
   .
  ITAB-ORGANIZATIONNAME   = INTAB1-VTEXT  .
*  ITAB-PLANARRIVALTIME    = INTAB1-  .
  ITAB-PROJECTNAME        = INTAB1-POST1  .
  ITAB-PROJECTNO          = INTAB1-PSPNR  .
  PERFORM DELZERO(ZPUBFORM) CHANGING LIST-PROJECTNO .
  ITAB-CARNAME            = INTAB1-ZSJXM  .
  ITAB-CARPHONE           = INTAB1-ZSJDH  .
  ITAB-CARPLATE           = INTAB1-ZCHEHAO  .
*  ITAB-CARRIERCODE        = INTAB1-  .
  ITAB-CARRIERNAME        = INTAB1-ZYSGS  .
  ITAB-KNOW               = INTAB1-ZWLXZ  .
*  ITAB-INORGANIZATION     = INTAB1-  .
*  ITAB-INWAREHOUSE        = INTAB1-  .
*  ITAB-INWAREHOUSENAME    = INTAB1-  .
*  ITAB-SUPPLIERCODE       = INTAB1-  .
*  ITAB-REMARK             = INTAB1-  .

  ITAB-DETAIL_LIST = LIST[].

  DATA(WMSSTR) = /UI2/CL_JSON=>SERIALIZE( DATA = ITAB  COMPRESS = ABAP_FALSE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).

  P_INPUT = WMSSTR.

  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GP_SD_WMS_FHTZTB_POST' CHANGING WMSURL.
  IF WMSURL IS INITIAL.
    RTYPE = 'NE'.
    RTMSG = '发货通知单同步WMSURL未维护！'.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.
*调用函数HTTP

  PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING WMSURL.
  CALL FUNCTION 'ZFMS_15_HTTP'
    EXPORTING
      INPUT     = WMSSTR
      URL       = WMSURL
      REQMETHOD = 'POST' "HTTP 方法
      HTTP1_1   = 'X' "协议1.1/1.0
    IMPORTING
      OUTPUT    = WMSSTR_RE "返回JSON报文
      RTMSG     = WMSMSG "消息
      STATUS    = WMSSTA "HTTP状态
    EXCEPTIONS
      OTHERS    = 1.

  /UI2/CL_JSON=>DESERIALIZE( EXPORTING JSON = WMSSTR_RE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE CHANGING DATA = ITRE ).

  P_STATUS = WMSSTA.
  P_OUTPUT = WMSSTR_RE.

  IF ITRE-STATUS <> 'success'.
    RTYPE = 'E'.
    RTMSG = ITRE-MSG.
  ELSE.
    RTYPE = 'S'.
    RTMSG = ITRE-MSG.
  ENDIF.

  ZFMDATASAVE2 'R'.


ENDFUNCTION.
