FUNCTION ZFM_GP_SD_WMS_NXDTB_CANCEL.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  EXPORTING
*"     VALUE(P_OUTPUT) TYPE  STRING
*"     VALUE(P_STATUS) TYPE  I
*"     VALUE(RTYPE) TYPE  BAPI_MTYPE
*"     VALUE(RTMSG) TYPE  BAPI_MSG
*"  TABLES
*"      IN_TAB STRUCTURE  ZSSD252
*"----------------------------------------------------------------------

  ZFMDATASAVE1 'ZFM_GP_SD_WMS_NXDTB_CANCEL'.
  ZFMDATASAVE2 'B'.
  TYPES: BEGIN OF T_DETAILLIST2,"明细
           PRODUCTCODE         TYPE  STRING,
           PKGNO               TYPE  STRING,
           QTY                 TYPE  STRING,
           BLOCKS              TYPE  STRING,
           UNIT                TYPE  STRING,
           TARGETCONTRACTNO    TYPE  STRING,
           TARGETCONTRACTNAME  TYPE  STRING,
           TARGETPROJECTNO     TYPE  STRING,
           TARGETPROJECTNAME   TYPE  STRING,
           ORIGINCONTRACTNO    TYPE  STRING,
           ORIGINCONTRACTNAME  TYPE  STRING,
           ORIGINPROJECTNO     TYPE  STRING,
           ORIGINPROJECTNAME   TYPE  STRING,
           DETAILLINEOPERATION TYPE  STRING,
         END OF T_DETAILLIST2.
  TYPES: TT_DETAILLIST2 TYPE STANDARD TABLE OF T_DETAILLIST2 WITH DEFAULT KEY.
* 报文结构
  TYPES: BEGIN OF T_JSON1,
           CODE                     TYPE  STRING,
           PURCHASEORGANIZATION     TYPE  STRING,
           PURCHASEORGANIZATIONNAME TYPE  STRING,
           PURCHASEWAREHOUSE        TYPE  STRING,
           PURCHASEWAREHOUSENAME    TYPE  STRING,
           SELLORGANIZATION         TYPE  STRING,
           SELLORGANIZATIONNAME     TYPE  STRING,
           SELLWAREHOUSE            TYPE  STRING,
           SELLWAREHOUSENAME        TYPE  STRING,
           SELLWORKSHOP             TYPE  STRING,
           TEMPORARYWAREHOUSE       TYPE  STRING,
           TEMPORARYWAREHOUSENAME   TYPE  STRING,
           SINGLE                   TYPE  STRING,
           SINGLEDATETIME           TYPE  STRING,
           OUTDATETIME              TYPE  STRING,
           DETAILLIST               TYPE TT_DETAILLIST2,
         END OF T_JSON1.
*         返回报文结构
  TYPES: BEGIN OF T_JSON2,
           ID         TYPE STRING,
           ERROR_CODE TYPE STRING,
           STATUS     TYPE STRING,
           MSG        TYPE STRING,
           PDF_URL    TYPE STRING,
           PRINT_URL  TYPE STRING,
         END OF T_JSON2.

  DATA:ITAB      TYPE T_JSON1,
       ITAB_DE   TYPE TABLE OF T_DETAILLIST2 WITH HEADER LINE,
       ITRE      TYPE T_JSON2,
       WMSURL    TYPE STRING,
       WMSMSG    TYPE STRING,
       WMSSTA    TYPE I,
       WMSSTR_RE TYPE STRING.

  CLEAR:ITAB,ITRE,ITAB_DE[].
  CHECK IN_TAB[] IS NOT INITIAL.
*填充明细
  LOOP AT IN_TAB.
    ITAB_DE-PRODUCTCODE         = IN_TAB-MATNR    .
    ITAB_DE-PKGNO               = IN_TAB-ZBAOH    .
    ITAB_DE-QTY                 = IN_TAB-LFIMG    .
    ITAB_DE-BLOCKS              = IN_TAB-ZKS    .
    ITAB_DE-UNIT                = IN_TAB-MEINS    .
    ITAB_DE-TARGETCONTRACTNO    = IN_TAB-POSNR_MB   .
    ITAB_DE-TARGETCONTRACTNAME  = IN_TAB-VBELN_MB   .
    ITAB_DE-TARGETPROJECTNO     = IN_TAB-PSPHI_MB   .
    ITAB_DE-TARGETPROJECTNAME   = IN_TAB-POST1_MB   .
    ITAB_DE-ORIGINCONTRACTNO    = IN_TAB-POSNR_Y    .
    ITAB_DE-ORIGINCONTRACTNAME  = IN_TAB-VBELN_Y    .
    ITAB_DE-ORIGINPROJECTNO     = IN_TAB-PSPHI_Y    .
    ITAB_DE-ORIGINPROJECTNAME   = IN_TAB-POST1_Y    .
    ITAB_DE-DETAILLINEOPERATION = IN_TAB-ZHCZ   .
    APPEND ITAB_DE.
  ENDLOOP.
*  填充抬头
  READ TABLE IN_TAB INDEX 1.
  ITAB-CODE                     = IN_TAB-VBELN  .
  ITAB-PURCHASEORGANIZATION	    =	IN_TAB-WERKS_CG	.
  ITAB-PURCHASEORGANIZATIONNAME	=	IN_TAB-WERKSNAME_CG	.
  ITAB-PURCHASEWAREHOUSE        = IN_TAB-LGORT_CG .
  ITAB-PURCHASEWAREHOUSENAME    = IN_TAB-LGORTNAME_CG .
  ITAB-SELLORGANIZATION         = IN_TAB-WERKS_XS .
  ITAB-SELLORGANIZATIONNAME	    =	IN_TAB-WERKSNAME_XS	.
  ITAB-SELLWAREHOUSE            = IN_TAB-LGORT_XS .
  ITAB-SELLWAREHOUSENAME        = IN_TAB-LGORTNAME_XS .
  ITAB-SELLWORKSHOP	            =	IN_TAB-ZCHEJIAN	.
  ITAB-TEMPORARYWAREHOUSE	      =	IN_TAB-LGORT_LS	.
  ITAB-TEMPORARYWAREHOUSENAME	  =	IN_TAB-LGORTNAME_LS	.
  ITAB-SINGLE                   = IN_TAB-ERNAM  .
  ITAB-SINGLEDATETIME           = IN_TAB-ERDAT  .
  ITAB-OUTDATETIME              = IN_TAB-ZODT .
  ITAB-DETAILLIST = ITAB_DE[].

*
  DATA(WMSSTR) = /UI2/CL_JSON=>SERIALIZE( DATA = ITAB  COMPRESS = ABAP_FALSE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
*
*  P_INPUT = WMSSTR.
*
  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GP_SD_WMS_NXDTB_CANCEL' CHANGING WMSURL.
  IF WMSURL IS INITIAL.
    RTYPE = 'N'.
    RTMSG = '内销单同步WMS的URL未维护！'.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.
*调用函数HTTP

  PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING WMSURL.
  CALL FUNCTION 'ZFMS_15_HTTP'
    EXPORTING
      INPUT     = WMSSTR
      URL       = WMSURL
      REQMETHOD = 'POST' "HTTP 方法
      HTTP1_1   = 'X' "协议1.1/1.0
    IMPORTING
      OUTPUT    = WMSSTR_RE "返回JSON报文
      RTMSG     = WMSMSG "消息
      STATUS    = WMSSTA "HTTP状态
    EXCEPTIONS
      OTHERS    = 1.
*解析返回的json
  /UI2/CL_JSON=>DESERIALIZE( EXPORTING JSON = WMSSTR_RE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE CHANGING DATA = ITRE ).

  P_STATUS = WMSSTA.
  P_OUTPUT = WMSSTR_RE.
  RTYPE = ITRE-STATUS.
  RTMSG = ITRE-MSG.

  ZFMDATASAVE2 'R'.


ENDFUNCTION.
