FUNCTION ZFM_GP_MM_WMS_LOCKUNLOCK.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  EXPORTING
*"     VALUE(P_OUTPUT) TYPE  STRING
*"     VALUE(P_STATUS) TYPE  I
*"     VALUE(P_RESULT) TYPE  STRING
*"     VALUE(RTYPE) TYPE  BAPI_MTYPE
*"     VALUE(RTMSG) TYPE  BAPI_MSG
*"     VALUE(FLAG) TYPE  BAPI_MTYPE
*"     VALUE(MESSAGE) TYPE  BAPI_MSG
*"  TABLES
*"      IT_HEAD STRUCTURE  ZSMM_223
*"      IT_ITEM STRUCTURE  ZSMM_224
*"      OT_ITEM STRUCTURE  ZSMM_017 OPTIONAL
*"----------------------------------------------------------------------

  ZFMDATASAVE1 'ZFM_GP_MM_WMS_LOCKUNLOCK'.
  ZFMDATASAVE2 'B'.
  TYPES: BEGIN OF T_DETAILLIST2,
           ID                TYPE  I,
           PRODUCTCODE       TYPE  STRING,
           QTY               TYPE  STRING,
           UNIT              TYPE  STRING,
           REELNO            TYPE  STRING,
           SELFNUMBER        TYPE  STRING,
           TARGETPROJECTNO   TYPE  STRING,
           TARGETPROJECTNAME TYPE  STRING,
           ORIGINPROJECTNO   TYPE  STRING,
           ORIGINPROJECTNAM  TYPE  STRING,
           TARGETCONTRACTNO  TYPE  STRING,
           ORIGINCONTRACTNO  TYPE  STRING,
           BATCHNO           TYPE  STRING,
         END OF T_DETAILLIST2.
  TYPES: TT_DETAILLIST2 TYPE STANDARD TABLE OF T_DETAILLIST2 WITH DEFAULT KEY.
  TYPES: BEGIN OF T_JSON1,
           WAREHOUSE 	       TYPE	  I,
           WAREHOUSENAME     TYPE   STRING,
           WORKSHOP          TYPE   STRING,
           CUSTOMERCODE      TYPE   STRING,
           OPERATIONDATETIME TYPE   STRING,
           OPERATIONTTYOE    TYPE   STRING,
           OPERATOR          TYPE   STRING,
           ORGANIZATION      TYPE   I,
           ORGANIZATIONNAME  TYPE   STRING,
           REMARK            TYPE   STRING,

           DETAILLIST        TYPE TT_DETAILLIST2,
         END OF T_JSON1.

  TYPES: BEGIN OF T_JSON2,
           ID         TYPE STRING,
           ERROR_CODE TYPE STRING,
           STATUS     TYPE STRING,
           MSG        TYPE STRING,
*           pdf_url    TYPE string,
*           print_url  TYPE string,
         END OF T_JSON2.

  DATA:ITAB      TYPE T_JSON1,
       ITAB_DE   TYPE TABLE OF T_DETAILLIST2 WITH HEADER LINE, "明细
       ITRE      TYPE T_JSON2,
       WMSURL    TYPE STRING,
       WMSMSG    TYPE STRING,
       WMSSTA    TYPE I,
       WMSSTR_RE TYPE STRING.
  CLEAR:ITAB,ITRE,ITAB_DE[].
  CHECK IT_ITEM[] IS NOT INITIAL.
  LOOP AT IT_ITEM.
    CLEAR ITAB_DE.
    ITAB_DE-ID                = IT_ITEM-ZDH.
    ITAB_DE-PRODUCTCODE       = IT_ITEM-MATNR.
    ITAB_DE-QTY               = IT_ITEM-ZSL.
    CONDENSE ITAB_DE-QTY.
    ITAB_DE-UNIT              = IT_ITEM-MEINS.
    ITAB_DE-REELNO            = IT_ITEM-ZJH.
    ITAB_DE-SELFNUMBER        = IT_ITEM-ZZBH.
    CALL FUNCTION 'CONVERSION_EXIT_ABPSP_INPUT'
      EXPORTING
        INPUT     = IT_ITEM-ZXXMH
      IMPORTING
        OUTPUT    = ITAB_DE-TARGETPROJECTNO
      EXCEPTIONS
        NOT_FOUND = 1
        OTHERS    = 2.
    PERFORM DELZERO(ZPUBFORM) CHANGING ITAB_DE-TARGETPROJECTNO.
*    ITAB_DE-targetProjectNo   = IT_ITEM-ZXXMH.
    ITAB_DE-TARGETPROJECTNAME = IT_ITEM-POST1.
    CALL FUNCTION 'CONVERSION_EXIT_ABPSP_INPUT'
      EXPORTING
        INPUT     = IT_ITEM-ZYXMH
      IMPORTING
        OUTPUT    = ITAB_DE-ORIGINPROJECTNO
      EXCEPTIONS
        NOT_FOUND = 1
        OTHERS    = 2.
    PERFORM DELZERO(ZPUBFORM) CHANGING ITAB_DE-ORIGINPROJECTNO.
    ITAB_DE-ORIGINPROJECTNAM  = IT_ITEM-ZYXMMC.
    ITAB_DE-TARGETCONTRACTNO  = IT_ITEM-ZXSDDH.
    ITAB_DE-ORIGINCONTRACTNO  = IT_ITEM-ZYXSHT.
    ITAB_DE-BATCHNO           = IT_ITEM-CHARG.
    APPEND ITAB_DE.
  ENDLOOP.
* 根据配置表找到工厂和库存地
  SELECT
  SINGLE *
  INTO  @DATA(IT_WL)
  FROM ZSAP2WMS
  WHERE LGORT = @IT_HEAD-LGORT AND WERKS = @IT_HEAD-WERKS.
  ITAB-WAREHOUSE          = IT_WL-ERPLGORT.
  ITAB-WAREHOUSENAME      = IT_WL-LGOBE.
  ITAB-WORKSHOP           = IT_HEAD-ZCJ  .
  ITAB-CUSTOMERCODE       = IT_HEAD-KUNNR.
  ITAB-OPERATIONDATETIME  = IT_HEAD-ZGXSJ+0(4) && '-' && IT_HEAD-ZGXSJ+4(2) && '-' && IT_HEAD-ZGXSJ+6(2) .
  ITAB-OPERATIONTTYOE     = IT_HEAD-ZJSJS  .
  ITAB-OPERATOR           = IT_HEAD-ZSDR   .
  ITAB-ORGANIZATION       = IT_WL-ERPJG  .
  ITAB-ORGANIZATIONNAME   = IT_WL-ERPJGMS.
  ITAB-REMARK             = IT_HEAD-ZBZ    .
  ITAB-DETAILLIST = ITAB_DE[].

  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GP_MM_WMS_LOCKUNLOCK' CHANGING WMSURL.
*  CHECK wmsurl IS NOT INITIAL.
  IF WMSURL IS INITIAL.
    RTYPE = 'E'.
    RTMSG = '锁定/解锁WMSURL未维护！'.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.

  DATA(WMSSTR) = /UI2/CL_JSON=>SERIALIZE( DATA = ITAB  COMPRESS = ABAP_FALSE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).
  P_OUTPUT = WMSSTR.

*调用函数HTTP

  PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING WMSURL.
  CALL FUNCTION 'ZFMS_15_HTTP'
    EXPORTING
      INPUT     = WMSSTR
      URL       = WMSURL
      REQMETHOD = 'POST' "HTTP 方法
      HTTP1_1   = 'X' "协议1.1/1.0
    IMPORTING
      OUTPUT    = WMSSTR_RE "返回JSON报文
      RTMSG     = WMSMSG "消息
      STATUS    = WMSSTA "HTTP状态
    EXCEPTIONS
      OTHERS    = 1.
*返回报文转为SAP结构

  /UI2/CL_JSON=>DESERIALIZE( EXPORTING JSON = WMSSTR_RE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE CHANGING DATA = ITRE ).

  P_STATUS = WMSSTA.
  P_RESULT = WMSSTR_RE.

  RTYPE = ITRE-STATUS.
  RTMSG = ITRE-MSG.
  LOOP AT OT_ITEM.
    OT_ITEM-FLAG    = ITRE-STATUS.
    OT_ITEM-MESSAGE = ITRE-MSG.
    APPEND OT_ITEM.
  ENDLOOP.

  ZFMDATASAVE2 'R'.


ENDFUNCTION.
