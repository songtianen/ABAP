FUNCTION ZFM_GP_SD_WMS_CKDTB_POST.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(WMSNO) TYPE  BSTKD OPTIONAL
*"     VALUE(ERPBILLCODE) TYPE  VBELN OPTIONAL
*"     VALUE(STATUS) TYPE  CHAR100 OPTIONAL
*"     VALUE(WAREHOUSE) TYPE  CHAR10 OPTIONAL
*"  EXPORTING
*"     VALUE(P_INPUT) TYPE  STRING
*"     VALUE(P_OUTPUT) TYPE  STRING
*"     VALUE(P_STATUS) TYPE  I
*"     VALUE(RTYPE) TYPE  BAPI_MTYPE
*"     VALUE(RTMSG) TYPE  BAPI_MSG
*"----------------------------------------------------------------------

  ZFMDATASAVE1 'ZFM_GP_SD_WMS_CKDTB_POST'.
  ZFMDATASAVE2 'B'.

  TYPES: BEGIN OF ZSPOST,
           ERPBILLCODE TYPE STRING,
           WMSNO       TYPE STRING,
           WAREHOUSE   TYPE STRING,
           STATUS      TYPE STRING,
           BILLTYPE    TYPE STRING,
           TYPE        TYPE STRING,
         END OF ZSPOST.

  DATA:ITAB   TYPE ZSPOST,
       WMSURL TYPE STRING,
       WMSMSG TYPE STRING,
       WMSSTA TYPE I.

  IF STATUS = 'SUCCESS' AND ERPBILLCODE IS NOT INITIAL.

    DO 100 TIMES.
      SELECT SINGLE
        VBELN
        INTO @DATA(VBELN)
        FROM LIKP
        WHERE LIKP~VBELN = @ERPBILLCODE
        .
      IF SY-SUBRC = 0 .
        UPDATE LIKP SET ZWMSDH = WMSNO WHERE VBELN = ERPBILLCODE .
      ELSE.
        WAIT UP TO '0.1' SECONDS .
      ENDIF.
    ENDDO.

  ENDIF.

  ITAB-ERPBILLCODE = ERPBILLCODE.
  ITAB-WMSNO       = WMSNO.
  ITAB-WAREHOUSE   = WAREHOUSE.
  ITAB-STATUS      = STATUS.
  ITAB-BILLTYPE    = 'CK'.
  ITAB-TYPE        = 'CK'.


  DATA(WMSSTR) = /UI2/CL_JSON=>SERIALIZE( DATA = ITAB  COMPRESS = ABAP_FALSE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE ).

  P_INPUT = WMSSTR.

  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GP_SD_WMS_CKDTB_POST' CHANGING WMSURL.
  IF WMSURL IS INITIAL.
    RTYPE = 'E'.
    RTMSG = '发货通知单同步WMSURL未维护！'.
    ZFMDATASAVE2 'R'.
    RETURN.
  ENDIF.
*调用函数HTTP

  PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING WMSURL.
  CALL FUNCTION 'ZFMS_15_HTTP'
    EXPORTING
      INPUT     = WMSSTR
      URL       = WMSURL
      REQMETHOD = 'POST' "HTTP 方法
      HTTP1_1   = 'X' "协议1.1/1.0
    IMPORTING
*     OUTPUT    = WMSSTR_RE "返回JSON报文
      RTMSG     = WMSMSG "消息
      STATUS    = WMSSTA "HTTP状态
    EXCEPTIONS
      OTHERS    = 1.

*  /UI2/CL_JSON=>DESERIALIZE( EXPORTING JSON = WMSSTR_RE PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE CHANGING DATA = ITRE ).

*  P_STATUS = WMSSTA.
*  P_OUTPUT = WMSSTR_RE.

*  RTYPE = ITRE-STATUS.
*  RTMSG = ITRE-MSG.
  P_STATUS =  WMSSTA.
  IF WMSSTA = 200.
    RTYPE	= 'S'.
    RTMSG = '推送成功！'.

  ELSE.
    RTYPE = 'E'.
    RTMSG = '推送失败！'.
  ENDIF.

  ZFMDATASAVE2 'R'.


ENDFUNCTION.
