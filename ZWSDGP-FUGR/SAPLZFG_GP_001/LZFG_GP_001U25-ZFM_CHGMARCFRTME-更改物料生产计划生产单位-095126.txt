FUNCTION ZFM_CHGMARCFRTME.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     REFERENCE(WERKS) TYPE  WERKS_D
*"     REFERENCE(MATNR) TYPE  MATNR
*"     REFERENCE(MEINS) TYPE  MEINS
*"  EXPORTING
*"     REFERENCE(RTYPE) TYPE  BAPI_MTYPE
*"     REFERENCE(RTMSG) TYPE  BAPI_MSG
*"----------------------------------------------------------------------
  DATA:HEADDATA        TYPE BAPIMATHEAD,
       WA_RETURN       TYPE BAPIRET2,
       PLANTDATA       TYPE BAPI_MARC,
       PLANTDATAX      TYPE BAPI_MARCX,
       UNITSOFMEASURE  TYPE TABLE OF BAPI_MARM WITH HEADER LINE,
       UNITSOFMEASUREX TYPE TABLE OF BAPI_MARMX WITH HEADER LINE,
       RETURNMESSAGES  TYPE TABLE OF BAPI_MATRETURN2 WITH HEADER LINE.
  DATA:FRTME TYPE MEINS.
  CLEAR:PLANTDATA,PLANTDATAX,HEADDATA,WA_RETURN,RETURNMESSAGES[],
  MARC,FRTME.
*单位转换
  CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT'
    EXPORTING
      INPUT          = MEINS
      LANGUAGE       = SY-LANGU
    IMPORTING
      OUTPUT         = FRTME
    EXCEPTIONS
      UNIT_NOT_FOUND = 1
      OTHERS         = 2.
  IF FRTME IS INITIAL .
    FRTME = MEINS.
  ENDIF.
  SELECT SINGLE *
    FROM MARC
    WHERE WERKS = WERKS
    AND   MATNR = MATNR.
  IF SY-SUBRC NE 0.
    FILLMSG 'E' '更改物料生产单位:未找到物料' 'X'.
  ENDIF.
  IF MARC-FRTME = FRTME.
    FILLMSG 'S' '无需更改' 'X'.
  ENDIF.
  SELECT SINGLE *
    FROM MARA
    WHERE MATNR = MATNR.
  IF MARA-MEINS = FRTME.
    FILLMSG 'S' '无需更改' 'X'.
  ENDIF.

  HEADDATA-MATERIAL = MATNR.
  HEADDATA-WORK_SCHED_VIEW = 'X'.

  PLANTDATA-PLANT = WERKS.
  PLANTDATA-PROD_UNIT = FRTME.
  PERFORM SETBAPIX(ZPUBFORM) USING PLANTDATA CHANGING PLANTDATAX.
*维护转换因子
  SELECT SINGLE COUNT(*)
    FROM MARM
    WHERE MATNR = MATNR
    AND   MEINH = MEINS.
  IF SY-SUBRC NE 0.
    UNITSOFMEASURE-ALT_UNIT = FRTME.
    UNITSOFMEASURE-NUMERATOR = 1.
    UNITSOFMEASURE-DENOMINATR = 1.
    UNITSOFMEASUREX-ALT_UNIT = FRTME.
    UNITSOFMEASUREX-NUMERATOR = 'X'.
    UNITSOFMEASUREX-DENOMINATR = 'X'.
    APPEND:UNITSOFMEASURE,UNITSOFMEASUREX.
  ENDIF.
  SET UPDATE TASK LOCAL.
  CALL FUNCTION 'BAPI_MATERIAL_SAVEDATA'
    EXPORTING
      HEADDATA        = HEADDATA
      PLANTDATA       = PLANTDATA
      PLANTDATAX      = PLANTDATAX
    IMPORTING
      RETURN          = WA_RETURN
    TABLES
      UNITSOFMEASURE  = UNITSOFMEASURE
      UNITSOFMEASUREX = UNITSOFMEASUREX
      RETURNMESSAGES  = RETURNMESSAGES.
  LOOP AT RETURNMESSAGES WHERE TYPE CA 'AEX'.
    CONCATENATE RETURNMESSAGES-MESSAGE RTMSG
    INTO RTMSG SEPARATED BY '/'.
  ENDLOOP.
  IF SY-SUBRC EQ 0
    OR WA_RETURN-TYPE CA 'AEX'.
    PERFORM BAPIRUN(ZPUBFORM) USING 'E'.
    CONCATENATE WA_RETURN-MESSAGE RTMSG
    INTO RTMSG SEPARATED BY '/'.
    CONCATENATE '更改物料生产单位:' RTMSG
    INTO RTMSG.
    RTYPE = 'E'.
  ELSE.
    SET UPDATE TASK LOCAL.
    PERFORM BAPIRUN(ZPUBFORM) USING 'S'.
    RTMSG = '成功'.
    RTYPE = 'S'.
  ENDIF.
ENDFUNCTION.
