FUNCTION ZFM_MM_CHGPOZJ.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     REFERENCE(EBELN) TYPE  EBELN
*"  EXPORTING
*"     REFERENCE(RTYPE) TYPE  BAPI_MTYPE
*"     REFERENCE(RTMSG) TYPE  BAPI_MSG
*"  TABLES
*"      INTAB STRUCTURE  ZSMM212
*"      RETURN STRUCTURE  BAPIRET2 OPTIONAL
*"----------------------------------------------------------------------
  DATA:POCOMPONENTS  TYPE TABLE OF BAPIMEPOCOMPONENT WITH HEADER LINE,
       POCOMPONENTSX TYPE TABLE OF BAPIMEPOCOMPONENTX WITH HEADER LINE,
       IT_EBELP      TYPE TABLE OF EKPO_KEY WITH HEADER LINE.
  DATA:RSPOS TYPE RESB-RSPOS.
  CLEAR:RETURN[],POCOMPONENTS[],POCOMPONENTSX[],IT_EBELP[].
  DELETE INTAB WHERE EBELP IS INITIAL
                  OR IDNRK IS INITIAL
                  OR BDMNG IS INITIAL.
  IF INTAB[] IS INITIAL.
    FILLMSG 'E' '无数据' 'X'.
  ENDIF.
  SORT INTAB BY EBELP.
  SELECT *
    INTO TABLE @DATA(IT_ZVMMPO)
    FROM ZVMMPO
    FOR ALL ENTRIES IN @INTAB
    WHERE EBELP = @INTAB-EBELP
    AND   EBELN = @EBELN.
  IF SY-SUBRC NE 0.
    FILLMSG 'E' '无PO' 'X'.
  ENDIF.
  LOOP AT INTAB.
    CLEAR:IT_EBELP.
    IT_EBELP-EBELP = INTAB-EBELP.
    COLLECT IT_EBELP.
  ENDLOOP.
  SORT IT_ZVMMPO BY RSNUM.
  SELECT *
    INTO TABLE @DATA(IT_RESB)
    FROM RESB
    FOR ALL ENTRIES IN @IT_ZVMMPO
    WHERE RSNUM = @IT_ZVMMPO-RSNUM.
  SORT IT_RESB BY EBELP RSPOS DESCENDING.
  DELETE ADJACENT DUPLICATES FROM IT_RESB
  COMPARING EBELP.
  SORT IT_ZVMMPO BY EBELP.
  LOOP AT IT_EBELP.
    CLEAR:RSPOS.
    READ TABLE IT_ZVMMPO INTO ZVMMPO WITH KEY EBELP = INTAB-EBELP BINARY SEARCH.
    IF SY-SUBRC NE 0.
      FILLMSG 'E' '行号不存在' 'X'.
    ENDIF.
    READ TABLE IT_RESB INTO RESB WITH KEY EBELP = IT_EBELP-EBELP BINARY SEARCH.
    IF SY-SUBRC EQ 0.
      RSPOS = RESB-RSPOS.
    ENDIF.
    LOOP AT INTAB WHERE EBELP = IT_EBELP-EBELP.
      CLEAR : POCOMPONENTS , POCOMPONENTSX .
*已有附件不能重复添加
      READ TABLE IT_RESB INTO RESB WITH KEY EBELP = IT_EBELP-EBELP
                                            MATNR = INTAB-IDNRK.
      IF SY-SUBRC EQ 0.
        CONTINUE.
      ENDIF.
      ADD 1 TO RSPOS.
      "组件
      POCOMPONENTS-PO_ITEM = IT_EBELP-EBELP.
      POCOMPONENTS-SCHED_LINE = '0001'.
      POCOMPONENTS-ITEM_NO =  RSPOS.
      POCOMPONENTS-MATERIAL = INTAB-IDNRK .
      POCOMPONENTS-PLANT = ZVMMPO-WERKS .
      POCOMPONENTS-REQ_DATE = ZVMMPO-EINDT.
*      POCOMPONENTS-REQ_QUAN = INTAB-BDMNG .
*      POCOMPONENTS-BASE_UOM = INTAB-MEINS .
      POCOMPONENTS-ENTRY_QUANTITY = INTAB-BDMNG .
      POCOMPONENTS-ENTRY_UOM = INTAB-MEINS .
*    POCOMPONENTS-BATCH = CHARG. "委外加工的 批次号
      POCOMPONENTS-CHANGE_ID = 'I'.
      PERFORM SETBAPIX(ZPUBFORM) USING POCOMPONENTS CHANGING POCOMPONENTSX.
      APPEND : POCOMPONENTS , POCOMPONENTSX .
    ENDLOOP.
  ENDLOOP.

  IF POCOMPONENTS[] IS NOT INITIAL.
    CALL FUNCTION 'BAPI_PO_CHANGE'
      EXPORTING
        PURCHASEORDER    = EBELN
        NO_PRICE_FROM_PO = 'X'
      TABLES
        RETURN           = RETURN
        POCOMPONENTS     = POCOMPONENTS
        POCOMPONENTSX    = POCOMPONENTSX.

    LOOP AT RETURN WHERE TYPE CA 'AEX'.
      CONCATENATE RTMSG RETURN-MESSAGE INTO RTMSG.
    ENDLOOP.
    IF SY-SUBRC = 0.
      RTYPE = 'E'.
      PERFORM BAPIRUN(ZPUBFORM) USING 'E'.
      RETURN.
    ELSE.
      PERFORM BAPIRUN(ZPUBFORM) USING 'S'.
      RTYPE = 'S'.
      RTMSG = '成功'.
    ENDIF.
  ENDIF.
  RTYPE = 'S'.
  RTMSG = '成功'.


ENDFUNCTION.
