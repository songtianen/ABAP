FUNCTION ZFM_ERP_CALLFILE.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     REFERENCE(SAPMK) TYPE  ZEFILE_SAPMK
*"     REFERENCE(DJLX) TYPE  ZEFILE_SAPDJLX
*"     REFERENCE(SAPNO)
*"----------------------------------------------------------------------
  DATA BEGIN OF ITAB OCCURS 0.
  INCLUDE STRUCTURE ZTMM237.
  DATA:URL TYPE STRING,
       END OF ITAB.
  DATA:FIELDCAT TYPE SLIS_T_FIELDCAT_ALV.
  DATA:URL TYPE STRING.
  CLEAR:ITAB[],FIELDCAT.
  SELECT *
    INTO CORRESPONDING FIELDS OF TABLE ITAB
    FROM ZTMM237
    WHERE SAPMK = SAPMK
    AND   DJLX = DJLX
    AND   SAPNO = SAPNO.
  DELETE ITAB WHERE ZFJDZ IS INITIAL.
  CHECK ITAB[] IS NOT INITIAL.
*获取地址
  PERFORM GETDATA(ZPUB_DATA) USING 'ZFM_GP_MM_ERP_TBCGUQ' CHANGING URL.
  CHECK URL IS NOT INITIAL.

  LOOP AT ITAB.
    CONCATENATE URL ITAB-ZFJDZ INTO ITAB-URL.
    MODIFY ITAB.
  ENDLOOP.

  PERFORM INIT_FIELDCAT(ZPUBFORM) TABLES FIELDCAT USING:
'SAPMK' 'SAP模块' '' '' '' '',
'DJLX' '单据类型' '' '' '' '',
'SAPNO' '单据号' '' '' '' '',
'URL' '地址' '' '' 'X' ''.
  LOOP AT FIELDCAT INTO DATA(WA_FIELD) WHERE FIELDNAME = 'URL'.
    WA_FIELD-OUTPUTLEN = 200.
    MODIFY FIELDCAT FROM WA_FIELD TRANSPORTING OUTPUTLEN.
  ENDLOOP.
  EXPORT OUTTAB = ITAB
  TO MEMORY ID 'ZFM_ERP_CALLFILE'.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      I_CALLBACK_PROGRAM      = SY-REPID
      IT_FIELDCAT             = FIELDCAT[]
      I_SAVE                  = 'A' "控制缺省/特定用户
      I_CALLBACK_USER_COMMAND = 'USER_COMMAND'
      I_SCREEN_START_COLUMN   = 45
      I_SCREEN_END_COLUMN     = 180
      I_SCREEN_START_LINE     = 10
      I_SCREEN_END_LINE       = 20
    TABLES
      T_OUTTAB                = ITAB[]
    EXCEPTIONS
      PROGRAM_ERROR           = 1
      OTHERS                  = 2.
ENDFUNCTION.
FORM USER_COMMAND USING R_UCOMM LIKE SY-UCOMM
                        RS_SELFIELD TYPE SLIS_SELFIELD.
  DATA BEGIN OF ITAB1 OCCURS 0.
  INCLUDE STRUCTURE ZTMM237.
  DATA:URL TYPE STRING,
       END OF ITAB1.
  DATA:URLC(1024) TYPE C.
  CLEAR:ITAB1[],ITAB1.
  IMPORT OUTTAB = ITAB1
  FROM MEMORY ID 'ZFM_ERP_CALLFILE'.

  CASE R_UCOMM.
    WHEN '&IC1'.
      CHECK RS_SELFIELD-TABINDEX <> 0 . "小计行总计行什么的忽略
      READ TABLE ITAB1  INDEX RS_SELFIELD-TABINDEX.
      CASE RS_SELFIELD-FIELDNAME.
        WHEN 'URL'.
          PERFORM REPLACE(ZPUBFORM) USING 'https' 'http' CHANGING ITAB1-URL.
          PERFORM REPLACE(ZPUBFORM) USING 'HTTPS' 'HTTP' CHANGING ITAB1-URL.
          URLC = ITAB1-URL.
          CALL FUNCTION 'CALL_BROWSER'
            EXPORTING
              URL                    = URLC
              NEW_WINDOW             = 'X'
*             BROWSER_TYPE           =
*             CONTEXTSTRING          =
            EXCEPTIONS
              FRONTEND_NOT_SUPPORTED = 1
              FRONTEND_ERROR         = 2
              PROG_NOT_FOUND         = 3
              NO_BATCH               = 4
              UNSPECIFIED_ERROR      = 5
              OTHERS                 = 6.
      ENDCASE.
    WHEN ''.
  ENDCASE.
  RS_SELFIELD-ROW_STABLE = 'X'.
  RS_SELFIELD-COL_STABLE = 'X'.
  RS_SELFIELD-REFRESH = 'X'.
ENDFORM.
