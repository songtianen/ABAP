*&---------------------------------------------------------------------*
*& Include ZRMM206_TOP
*&---------------------------------------------------------------------*
TYPE-POOLS:SLIS,ICON.
DATA:FIELDCAT   TYPE SLIS_T_FIELDCAT_ALV,
     FIELDCAT1  TYPE SLIS_T_FIELDCAT_ALV,
     FIELDCATEX TYPE SLIS_T_FIELDCAT_ALV,
     WA_FIELD   TYPE SLIS_FIELDCAT_ALV.
TYPES:BEGIN OF TY_OUT1,
        SEL,
        TOPPAGE,
        ICON    TYPE ICON-ID,
        MSG     TYPE BAPI_MSG,
        CHBOX1  TYPE CHAR1,
        HANDLE,
      END OF TY_OUT1,
      BEGIN OF TY_OUT2,
        ZDHLXT  TYPE DDTEXT,
        ZDHZTT  TYPE DDTEXT,
        ZTHFST  TYPE DDTEXT,
        ZJSFST  TYPE DDTEXT,
        ZYSFST  TYPE DDTEXT,
        ZYSFS1T TYPE DDTEXT,
        ZZFFST  TYPE DDTEXT,
        ZSFCCT  TYPE DDTEXT,
        ZSFHGT  TYPE DDTEXT,
        ZJGSDT  TYPE DDTEXT,
        ZFKFST  TYPE DDTEXT,
        ZFKLXT  TYPE DDTEXT,
        ZXCFT   TYPE DDTEXT,
        ZYFCDFT TYPE DDTEXT,
        ZCGLXT  TYPE DDTEXT,
        ZYSGST  TYPE NAME1,
      END OF TY_OUT2,
      BEGIN OF TY_OUT3,
        MAKTX TYPE MAKT-MAKTX,
        NAMEL TYPE LFA1-NAME1,
        LGOBE TYPE T001L-LGOBE,
        T024  TYPE T024-EKNAM,
        T024E TYPE T024E-EKOTX,
        BUTXT TYPE T001-BUTXT,
        T023T TYPE T023T-WGBEZ,
        PSPNR TYPE PRPS-PSPNR,
        POSID TYPE PRPS-POSID,
        POST1 TYPE PRPS-POST1,
        NAMEK TYPE KNA1-NAME1,
        NAMEW TYPE T001W-NAME1,
        ZSL   TYPE KBETR,
      END OF TY_OUT3,
      BEGIN OF TY_OUT4,
        EKGRP   TYPE EKKO-EKGRP,
        TXZ01   TYPE EKPO-TXZ01,
        MENGE   TYPE EKPO-MENGE,
        MEINS   TYPE EKPO-MEINS,
        KNUMV   TYPE EKKO-KNUMV,
        RSNUM   TYPE EKET-RSNUM,
        ZYSFSGP TYPE EKKO-ZYSFSGP,
        MAKTX   TYPE MAKTX,
        BANFN   TYPE EBAN-BANFN,
        BNFPO   TYPE EBAN-BNFPO,
        NAMEW   TYPE NAME1,
      END OF TY_OUT4,
      BEGIN OF TY_LIST,
        ID    TYPE CHAR10,
        VALUE TYPE CHAR50,
      END OF TY_LIST,
      BEGIN OF TY_EBAN,
        AFNAM    TYPE EBAN-AFNAM,
        ZZFDZ    TYPE EBAN-ZZFDZ,
        KUNNR    TYPE EBAN-KUNNR,
        KUNNRT   TYPE KNA1-NAME1,
        ZBAOGUAN TYPE EBAN-ZBAOGUAN,
        ZCHANDI  TYPE EBAN-ZCHANDI,
        BEDNR    TYPE EBAN-BEDNR,
        LGORT1   TYPE LGORT_D,
        LGOBE1   TYPE LGOBE,
        LFDAT    TYPE EBAN-LFDAT,
        ZSFZF    TYPE EBAN-ZSFZF,
      END OF TY_EBAN.
DATA BEGIN OF ITAB1 OCCURS 0.
INCLUDE STRUCTURE ZVMMPO.
INCLUDE TYPE TY_OUT3.
INCLUDE TYPE TY_EBAN.
DATA:CGWQ   TYPE EKPO-MENGE,
     SHMNG  TYPE EKPO-MENGE,
     ZZL1   TYPE MARA-ZZL1,
     PBXX   TYPE KBETR,
     K_PBXX TYPE KWERT,
     K_ZWVZ TYPE KWERT,
     ZBHSJE TYPE ZE_DMBTR,
     UMSON  TYPE CHAR1,
     JYSL   TYPE MENGE_D,
     JYJE   TYPE EKBE-WRBTR,
     SYJYSL TYPE MENGE_D,
     SYJYJE TYPE EKBE-WRBTR,
     LJFKJE TYPE EKBE-WRBTR, "订单累计付款额
     ZSYFK  TYPE EKBE-WRBTR,
     ZFKE   TYPE EKBE-WRBTR,
     FPJYHS TYPE EKBE-WRBTR,
     SYJYHS TYPE EKBE-WRBTR,
     ZWLCMS TYPE STRING.
     INCLUDE TYPE TY_OUT2.
     INCLUDE TYPE TY_OUT1.
DATA: END OF ITAB1,
BEGIN OF ITAB2 OCCURS 0.
  INCLUDE STRUCTURE ZTMM201.
  INCLUDE TYPE TY_OUT1.
  INCLUDE TYPE TY_OUT2.
DATA:END OF ITAB2,
BEGIN OF WA_MBLNR ,
  MBLNR  TYPE MBLNR,
  MJAHR  TYPE MJAHR,
  MBLNR1 TYPE MBLNR,
  BUDAT  TYPE BUDAT,
END OF WA_MBLNR,
BEGIN OF ITAB3 OCCURS 0.
  INCLUDE STRUCTURE ZVDHTZ.
  INCLUDE TYPE TY_OUT1.
  INCLUDE TYPE TY_OUT2.
  INCLUDE TYPE TY_OUT3.
  INCLUDE TYPE TY_EBAN.
DATA: KNUMV  TYPE EKKO-KNUMV,
  BANFN  TYPE EKPO-BANFN,
  BNFPO  TYPE EKPO-BNFPO,
  EKGRP  TYPE EKKO-EKGRP,
  MATKL  TYPE MARA-MATKL,
  ZZL1   TYPE MARA-ZZL1,
  ZWLCMS TYPE STRING,
END OF ITAB3,
BEGIN OF WA_HEAD.
  INCLUDE STRUCTURE ZTMM201.
DATA: ZCKMC  TYPE ZTMM215-ZCKMC,
  NAMEL  TYPE LFA1-NAME1,
  TDID   TYPE TDID,
  BSART  TYPE EKKO-BSART,
  WERKS  TYPE WERKS_D,
  EKORG  TYPE EKORG,
  ZWLYT  TYPE NAME1,
  ZSHRT  TYPE NAME1,
  ZYSRT  TYPE NAME1,
  ZYSGST TYPE NAME1,
  STATUS TYPE BAPI_MSG,
  MSG    TYPE BAPI_MSG,
END OF WA_HEAD,
BEGIN OF IT_ITEM OCCURS 0.
  INCLUDE STRUCTURE ZTMM202.
  INCLUDE TYPE TY_OUT4.
  INCLUDE TYPE TY_EBAN.
DATA: CHBOX  TYPE CHAR1,
  T024   TYPE EKNAM,
  PSPNR  TYPE PRPS-PSPNR,
  POSID  TYPE PRPS-POSID,
  POST1  TYPE PRPS-POST1,
  ZWLCMS TYPE BAPI_MSG,
  SHMNG  TYPE EKPO-MENGE,
  LGOBE  TYPE T001L-LGOBE,
  NAMEK  TYPE NAME1,
  ZBGT   TYPE NAME1,
  MATKL  TYPE MARA-MATKL,
  ZZL1   TYPE MARA-ZZL1,
END OF IT_ITEM,
BEGIN OF IT_TEXT OCCURS 0,
  TDID TYPE STXL-TDID.
  INCLUDE STRUCTURE ZSMM202.
DATA:END OF IT_TEXT,
BEGIN OF IT_UPLOAD OCCURS 0,
  EBELN TYPE EBELN,
  EBELP TYPE EBELP,
  ZJSL  TYPE ZTMM202-ZJSL,
  ZRKL  TYPE ZTMM202-ZRKL,
  ZBHGL TYPE ZTMM202-ZBHGL,
  RKDW  TYPE ZTMM202-RKDW,
  ZKW   TYPE ZTMM202-ZKW,
  ZJH   TYPE ZTMM202-ZJH,
  LGORT TYPE ZTMM202-LGORT,
  ZZBH  TYPE ZTMM202-ZZBH,
  ZBZH  TYPE ZTMM202-ZBZH,
  ZDHHH TYPE ZTMM202-ZDHHH,
END OF IT_UPLOAD,
BEGIN OF IT_ZDHHH OCCURS 0,
  ZDHHH TYPE ZTMM202-ZDHHH,
END OF IT_ZDHHH,
BEGIN OF IT_SHOW1 OCCURS 0,
  EBELN TYPE EKBE-EBELN,
  EBELP TYPE EKBE-EBELP,
  WRBTR TYPE EKBE-WRBTR,
  MENGE TYPE EKBE-MENGE,
  LFGJA TYPE EKBE-LFGJA,
  LFBNR TYPE EKBE-LFBNR,
  LFPOS TYPE EKBE-LFPOS,
  MWSKZ TYPE EKPO-MWSKZ,
  BUKRS TYPE EKKO-BUKRS,
  BUTXT TYPE BUTXT,
  ZZL1  TYPE MARA-ZZL1,
  NETPR TYPE EKPO-NETPR,
END OF IT_SHOW1,
BEGIN OF IT_JYSUM OCCURS 0,
  EBELN TYPE EKBE-EBELN,
  EBELP TYPE EKBE-EBELP,
  WRBTR TYPE EKBE-WRBTR,
  MENGE TYPE EKBE-MENGE,
END OF IT_JYSUM,
BEGIN OF IT_ZZBH OCCURS 0.
  INCLUDE STRUCTURE ZSPP_006.
DATA: N TYPE I,
END OF IT_ZZBH,
BEGIN OF IT_ZCONT OCCURS 0,
  ZCONT TYPE ZTFI_PYREHD-ZCONT,
END OF IT_ZCONT,
WA_ITEM     LIKE LINE OF IT_ITEM,
  IT_ZSMM206  TYPE TABLE OF ZSMM206 WITH HEADER LINE,
  IT_SHSUM    LIKE TABLE OF IT_JYSUM WITH HEADER LINE,
  IT_SYSUM    LIKE TABLE OF IT_JYSUM WITH HEADER LINE,
  IT_SHOW2    LIKE TABLE OF IT_SHOW1 WITH HEADER LINE,
  IT_ZSPP006  TYPE TABLE OF ZSPP_006 WITH HEADER LINE,
  IT_EBANS    TYPE TABLE OF TY_EBAN WITH HEADER LINE,
  TEXTTABLE   TYPE TABLE OF ZSMM202 WITH HEADER LINE,
  T_TEXT      TYPE TABLE OF ZSMM202 WITH HEADER LINE,
  IT_LIST2    TYPE TABLE OF TY_LIST WITH HEADER LINE,
  IT_MATNR    TYPE TABLE OF CCVX_MATNR WITH HEADER LINE,
  IT_LIFNR    TYPE TABLE OF LFA1_KEY WITH HEADER LINE,
  IT_ZDHDH    TYPE TABLE OF ZSMM201 WITH HEADER LINE,
  IT_MAKT     TYPE TABLE OF MAKT WITH HEADER LINE,
  IT_MARM     TYPE TABLE OF MARM WITH HEADER LINE,
  IT_MARA     TYPE TABLE OF MARA WITH HEADER LINE,
  IT_LFA1     TYPE TABLE OF LFA1 WITH HEADER LINE,
  ITAB1A      LIKE TABLE OF ITAB1 WITH HEADER LINE,
  ITAB1B      LIKE TABLE OF ITAB1 WITH HEADER LINE,
  IT_BANFN    TYPE TABLE OF BANF_KEY WITH HEADER LINE,
  IT_KUNNR    TYPE TABLE OF KNA1_KEY WITH HEADER LINE,
  IT_KNA1     TYPE TABLE OF KNA1 WITH HEADER LINE,
  IT_EBAN     TYPE TABLE OF EBAN WITH HEADER LINE,
  IT_T001     TYPE TABLE OF T001 WITH HEADER LINE,
  IT_T024     TYPE TABLE OF T024 WITH HEADER LINE,
  IT_T024E    TYPE TABLE OF T024E WITH HEADER LINE,
  IT_T023T    TYPE TABLE OF T023T WITH HEADER LINE,
  IT_T001L    TYPE TABLE OF T001L WITH HEADER LINE,
  IT_RESB     TYPE TABLE OF RESB WITH HEADER LINE,
  IT_RSNUM    TYPE TABLE OF RSNR WITH HEADER LINE,
  IT_ZDHLX    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZDHZT    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZTHFS    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_T001W    TYPE TABLE OF T001W WITH HEADER LINE,
  IT_ZJSFS    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZYSFS    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZYSFS1   TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZZFFS    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZSFCC    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZSFHG    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZJGSD    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZFKFS    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZFKLX    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZXCF     TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZYFCDF   TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZCGLX    TYPE TABLE OF DD07V WITH HEADER LINE,
  IT_ZTMM201  TYPE TABLE OF ZTMM201 WITH HEADER LINE,
  IT_ZTMM202  TYPE TABLE OF ZTMM202 WITH HEADER LINE,
  IT_ZTMM210  TYPE TABLE OF ZTMM210 WITH HEADER LINE,
  IT_ZTMM212  TYPE TABLE OF ZTMM212 WITH HEADER LINE,
  IT_ZTMM215  TYPE TABLE OF ZTMM215 WITH HEADER LINE,
  IT_ZTMM216  TYPE TABLE OF ZTMM216 WITH HEADER LINE,
  IT_ZVTMM215 TYPE TABLE OF ZVTMM215 WITH HEADER LINE,
  IT_EBELP    TYPE TABLE OF EKPO_KEY WITH HEADER LINE,
  IT_EKBE     TYPE TABLE OF EKBE WITH HEADER LINE,
  IT_EBELN    TYPE TABLE OF ZSPUBS_FIELD WITH HEADER LINE,
  IT_EKKN     TYPE TABLE OF EKKN WITH HEADER LINE,
  IT_PSPNR    TYPE TABLE OF RCJ_PSPNR WITH HEADER LINE,
  IT_PRPS     TYPE TABLE OF PRPS WITH HEADER LINE,
  IT_KNUMV    TYPE TABLE OF ZSMMKNUMV WITH HEADER LINE,
  IT_PRCD     TYPE TABLE OF PRCD_ELEMENTS WITH HEADER LINE,
  IT_CGWQ     TYPE TABLE OF ZSFMS_GETCGWQ WITH HEADER LINE,
  IT_ZVMMPO   TYPE TABLE OF ZVMMPO WITH HEADER LINE,
  RETURN      TYPE TABLE OF BAPIRET2 WITH HEADER LINE.
DATA:FLAG1     TYPE CHAR1, "I-查看采购订单，U-到货单维度
     FLAG2     TYPE CHAR1,
     P1_X      TYPE CHAR1,
     P2_X      TYPE CHAR1,
     P3_X      TYPE CHAR1,
     P4_X      TYPE CHAR1,
     P5_X      TYPE CHAR1,
     TEXT1     TYPE CHAR100,
     ERRORFLAGN TYPE CHAR1,
     TEXT2     TYPE CHAR100.
RANGES:S_ELIKZ FOR EKPO-ELIKZ,
       S_WEPOS FOR EKPO-WEPOS,
       S_PSTYP1 FOR EKPO-PSTYP,
       S_FRGKE FOR EKKO-FRGKE,
       S_DHZT FOR ZTMM201-ZDHZT.
CONSTANTS:TCODE1 TYPE SY-TCODE VALUE 'ZMM206A',
          TCODE2 TYPE SY-TCODE VALUE 'ZMM206B',
          TCODE3 TYPE SY-TCODE VALUE 'ZMM206C',
          TCODE4 TYPE SY-TCODE VALUE 'ZMM206D',
          TCODE5 TYPE SY-TCODE VALUE 'ZMM206E',
          CE     TYPE MENGE_D VALUE '0.3',
          EXEC   TYPE CHAR4 VALUE 'ONLI',
          GREEN  TYPE ICON-ID VALUE '@08@',
          RED    TYPE ICON-ID VALUE '@0A@'.
DATA:EXCLUDE     TYPE TABLE OF SY-UCOMM,
     TCODE       TYPE SY-TCODE,
     OK_CODE     TYPE SY-UCOMM,
     OK_CODE1    TYPE SY-UCOMM,
     TDID        TYPE TDID,
     NUM         TYPE I,
     ZDHHH       TYPE ZTMM202-ZDHHH,
     ANSWER      TYPE CHAR1,
     SELSTR      TYPE STRING,
     HANDLE      TYPE CHAR10,
     SELSTR1     TYPE STRING,
     MSG         TYPE BAPI_MSG,
     RTYPE       TYPE BAPI_MTYPE,
     RTMSG       TYPE BAPI_MSG,
     TABIX       TYPE SY-TABIX,
     TSFLG       TYPE CHAR1,
     L_ZDHDHLOCK TYPE ZTMM201-ZDHDH,
     SAPNO       TYPE ZTFILE_MANAGE_01-SAPNO,
     L_MSG       TYPE BAPI_MSG.
FIELD-SYMBOLS:<FS>      TYPE ANY,
              <IT_MODI> TYPE LVC_T_MODI,
              <WA>      TYPE ANY,
              <ITAB>    TYPE STANDARD TABLE.
RANGES:S_KTOKK FOR LFA1-KTOKK,
       D_WERKS FOR EKPO-WERKS.

*OO-ALV
DATA:GO_EDITOR           TYPE REF TO CL_GUI_TEXTEDIT,
     GO_EDITOR_CONTAINER TYPE REF TO CL_GUI_CUSTOM_CONTAINER.
DATA:CONTAIN       TYPE REF TO CL_GUI_CUSTOM_CONTAINER,
     ALVGRID       TYPE REF TO CL_GUI_ALV_GRID,
     IT_FIELDCAT   TYPE LVC_T_FCAT,
     IT_FIELDCATEX TYPE LVC_T_FCAT,
     WA_FIELDCAT   TYPE LVC_S_FCAT,
     IT_F4         TYPE  LVC_T_F4,
     WA_F4         TYPE  LVC_S_F4,
     IS_STABLE     TYPE LVC_S_STBL,
     WA_LAYOUT     TYPE LVC_S_LAYO,
     IT_EF1        TYPE UI_FUNCTIONS,
     VARIANT       TYPE DISVARIANT,
     CONTAIN1      TYPE REF TO CL_GUI_CUSTOM_CONTAINER,
     ALVGRID1      TYPE REF TO CL_GUI_ALV_GRID,
     IT_FIELDCAT1  TYPE LVC_T_FCAT,
     IS_STABLE1    TYPE LVC_S_STBL,
     WA_MODI       TYPE LVC_S_MODI,
     WA_RETURN_TAB TYPE DDSHRETVAL,
     RETURN_TAB    TYPE TABLE OF DDSHRETVAL WITH HEADER LINE,
     FIELD_TAB     TYPE TABLE OF DFIES WITH HEADER LINE.

DEFINE LOCK.
  CLEAR: L_ZDHDHLOCK,L_MSG.
  L_ZDHDHLOCK = &2.
IF &1 NE 'X'."加锁
CALL FUNCTION 'ENQUEUE_EZDHDH'
 EXPORTING
   ZDHDH                = L_ZDHDHLOCK
   _SCOPE               = '1'
 EXCEPTIONS
   FOREIGN_LOCK         = 1
   SYSTEM_FAILURE       = 2
   OTHERS               = 3.
IF SY-SUBRC <> 0.
MESSAGE E012 WITH SY-MSGV1 SY-TCODE L_ZDHDHLOCK.
ENDIF.
ELSE."解锁
CALL FUNCTION 'DEQUEUE_EZDHDH'
 EXPORTING
*   MODE_ZSMM201       = 'E'
   ZDHDH              = L_ZDHDHLOCK
   _SCOPE             = '1'.

ENDIF.
END-OF-DEFINITION.
DEFINE MSG.
  IF &1+0(1) = 'S'.
    MESSAGE &1 TYPE 'I'.
  ELSE.
    MESSAGE S000(OO) WITH &1 DISPLAY LIKE 'E'.
  ENDIF.
END-OF-DEFINITION.
